<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœ€ä½³å®è·µ - LangChain4j å­¦ä¹ æŒ‡å—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-gray-800 antialiased">
    <div class="flex min-h-screen">
        <aside class="w-[280px] fixed left-0 top-0 h-full bg-white border-r border-gray-200 overflow-y-auto z-50">
            <a href="index.html" class="flex items-center gap-3 mb-8 text-gray-900 no-underline">
                <div class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-xl">âš¡</div>
                <span class="font-bold text-xl">LangChain4j</span>
            </a>

            <div class="mb-8">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">å…¥é—¨</div>
                <ul class="list-none">
                    <li><a href="index.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">é¦–é¡µ</a></li>
                    <li><a href="getting-started.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">å¿«é€Ÿå…¥é—¨</a></li>
                    <li><a href="core-concepts.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">æ ¸å¿ƒæ¦‚å¿µ</a></li>
                </ul>
            </div>

            <div class="mb-8">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">åŸºç¡€</div>
                <ul class="list-none">
                    <li><a href="embedding-models.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">Embeddingæ¨¡å‹</a></li>
                    <li><a href="prompt-templates.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">Promptæ¨¡æ¿</a></li>
                    <li><a href="output-parsers.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">è¾“å‡ºè§£æ</a></li>
                    <li><a href="model-providers.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">æ¨¡å‹æä¾›å•†</a></li>
                </ul>
            </div>

            <div class="mb-8">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">è¿›é˜¶</div>
                <ul class="list-none">
                    <li><a href="function-calling-deep.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">Function Calling</a></li>
                    <li><a href="advanced-features.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">é«˜çº§ç‰¹æ€§</a></li>
                    <li><a href="multimodal-full.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">å¤šæ¨¡æ€èƒ½åŠ›</a></li>
                    <li><a href="rag-complete.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">RAGå®Œæ•´æŒ‡å—</a></li>
                    <li><a href="project-rag-kb.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">RAGçŸ¥è¯†åº“é¡¹ç›®</a></li>
                    <li><a href="project-ai-assistant.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">AIåŠ©æ‰‹é¡¹ç›®</a></li>
                    <li><a href="project-chatbot.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">èŠå¤©æœºå™¨äººé¡¹ç›®</a></li>
                </ul>
            </div>

            <div class="mb-8">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">å®è·µ</div>
                <ul class="list-none">
                    <li><a href="best-practices.html" class="bg-primary-50 text-indigo-700 block py-2 px-3 text-sm rounded-md font-medium">æœ€ä½³å®è·µ</a></li>
                    <li><a href="examples.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">å®æˆ˜ç¤ºä¾‹</a></li>
                    <li><a href="integrations.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">æ¡†æ¶é›†æˆ</a></li>
                    <li><a href="testing-strategies.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">æµ‹è¯•ç­–ç•¥</a></li>
                    <li><a href="performance-tuning.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">æ€§èƒ½è°ƒä¼˜</a></li>
                </ul>
            </div>

            <div class="mb-8">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">å…¶ä»–</div>
                <ul class="list-none">
                    <li><a href="deep-dive.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">æ·±åº¦è§£æ</a></li>
                    <li><a href="error-handling.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">é”™è¯¯å¤„ç†</a></li>
                    <li><a href="moderation-safety.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">å†…å®¹å®¡æ ¸</a></li>
                    <li><a href="troubleshooting.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">é—®é¢˜æ’æŸ¥</a></li>
                    <li><a href="interview-prep.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">é¢è¯•å‡†å¤‡</a></li>
                    <li><a href="practice.html" class="block text-gray-600 no-underline py-2 px-3 text-sm rounded-md hover:bg-gray-100 transition-all">ç»ƒä¹ é¡¹ç›®</a></li>
                </ul>
            </div>
        </aside>

        <main class="flex-1 ml-[280px] px-8 py-12 max-w-7xl">
            <div class="mb-8 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold">2025-02-14</span>
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">ç”Ÿäº§å®è·µ</span>
                    <span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-semibold">é«˜çº§éš¾åº¦</span>
                </div>
            </div>

            <h1 class="text-5xl font-bold text-gray-900 mb-6">LangChain4j æœ€ä½³å®è·µ</h1>

            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-indigo-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">ğŸ—ï¸</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">æ¶æ„è®¾è®¡</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ åˆ†å±‚æ¶æ„æ¨¡å¼</li>
                            <li>â€¢ æœåŠ¡æ‹†åˆ†åŸåˆ™</li>
                            <li>â€¢ æ¨¡å—åŒ–è®¾è®¡</li>
                        </ul>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">âš¡</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">æ€§èƒ½ä¼˜åŒ–</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ è¿æ¥æ± ç®¡ç†</li>
                            <li>â€¢ æ‰¹é‡å¤„ç†</li>
                            <li>â€¢ ç¼“å­˜ç­–ç•¥</li>
                        </ul>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-teal-50 border border-green-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">ğŸ›¡ï¸</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">å®‰å…¨å®è·µ</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ APIå¯†é’¥ç®¡ç†</li>
                            <li>â€¢ è¾“å…¥éªŒè¯</li>
                            <li>â€¢ å†…å®¹è¿‡æ»¤</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="mb-12 bg-blue-50 border border-blue-100 rounded-lg p-6">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ’¡</span>
                    <div>
                        <h3 class="font-bold text-gray-900 mb-2">å­¦ä¹ ç›®æ ‡</h3>
                        <ul class="text-gray-700 space-y-2 text-sm">
                            <li>â€¢ æŒæ¡ LangChain4j åº”ç”¨çš„æ¶æ„è®¾è®¡åŸåˆ™</li>
                            <li>â€¢ å­¦ä¹ æ€§èƒ½ä¼˜åŒ–æŠ€å·§å’Œæœ€ä½³å®è·µ</li>
                            <li>â€¢ ç†è§£é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶</li>
                            <li>â€¢ æŒæ¡å®‰å…¨é˜²æŠ¤å’Œåˆè§„è¦æ±‚</li>
                            <li>â€¢ å­¦ä¹ ç›‘æ§ã€æ—¥å¿—å’Œè°ƒè¯•æŠ€å·§</li>
                            <li>â€¢ äº†è§£æµ‹è¯•ç­–ç•¥å’ŒCI/CDé›†æˆ</li>
                        </ul>
                    </div>
                </div>
            </div>

            <section class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <span class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">1</span>
                    æ¶æ„è®¾è®¡åŸåˆ™
                </h2>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">1.1 åˆ†å±‚æ¶æ„</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">æ¨èçš„é¡¹ç›®ç»“æ„</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-plaintext">src/main/java/com/example/langchain4j/
â”œâ”€â”€ config/                    # é…ç½®å±‚
â”‚   â”œâ”€â”€ AiModelConfig.java    # AIæ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ EmbeddingConfig.java  # Embeddingé…ç½®
â”‚   â”œâ”€â”€ VectorStoreConfig.java # å‘é‡å­˜å‚¨é…ç½®
â”‚   â””â”€â”€ CacheConfig.java      # ç¼“å­˜é…ç½®
â”‚
â”œâ”€â”€ model/                     # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ entity/               # æ•°æ®åº“å®ä½“
â”‚   â””â”€â”€ vo/                   # è§†å›¾å¯¹è±¡
â”‚
â”œâ”€â”€ repository/                # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ DocumentRepository.java
â”‚   â”œâ”€â”€ ChatRepository.java
â”‚   â””â”€â”€ UserRepository.java
â”‚
â”œâ”€â”€ service/                   # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ chat/                 # èŠå¤©æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ChatService.java  # æœåŠ¡æ¥å£
â”‚   â”‚   â””â”€â”€ impl/             # æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ rag/                  # RAGæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ RagService.java
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â””â”€â”€ ai/                   # AIæœåŠ¡
â”‚       â”œâ”€â”€ AiAgent.java      # AIä»£ç†
â”‚       â”œâ”€â”€ ToolService.java  # å·¥å…·æœåŠ¡
â”‚       â””â”€â”€ MemoryService.java # è®°å¿†æœåŠ¡
â”‚
â”œâ”€â”€ controller/                # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ ChatController.java
â”‚   â”œâ”€â”€ RagController.java
â”‚   â””â”€â”€ DocumentController.java
â”‚
â”œâ”€â”€ exception/                 # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ AiException.java
â”‚   â””â”€â”€ GlobalExceptionHandler.java
â”‚
â””â”€â”€ util/                      # å·¥å…·ç±»
    â”œâ”€â”€ PromptTemplate.java
    â”œâ”€â”€ TextSplitter.java
    â””â”€â”€ Tokenizer.java
                    </code></pre>
                </div>

                <div class="bg-green-50 border border-green-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-green-600">âœ…</span> æ¨èåšæ³•
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>æ¸…æ™°çš„èŒè´£åˆ†ç¦»</strong>ï¼šControllerè´Ÿè´£è¯·æ±‚å¤„ç†ï¼ŒServiceè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼ŒRepositoryè´Ÿè´£æ•°æ®è®¿é—®</li>
                        <li>â€¢ <strong>é¢å‘æ¥å£ç¼–ç¨‹</strong>ï¼šServiceå±‚å®šä¹‰æ¥å£ï¼ŒimplåŒ…ä¸­å®ç°ï¼Œä¾¿äºæµ‹è¯•å’Œæ‰©å±•</li>
                        <li>â€¢ <strong>é…ç½®é›†ä¸­ç®¡ç†</strong>ï¼šæ‰€æœ‰AIæ¨¡å‹ã€å‘é‡å­˜å‚¨ç­‰é…ç½®ç»Ÿä¸€æ”¾åœ¨configåŒ…</li>
                        <li>â€¢ <strong>å¼‚å¸¸ç»Ÿä¸€å¤„ç†</strong>ï¼šå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç±»ï¼Œä½¿ç”¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€è¿”å›</li>
                    </ul>
                </div>

                <div class="bg-red-50 border border-red-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-red-600">âŒ</span> é¿å…çš„åšæ³•
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>åœ¨Controllerä¸­ç›´æ¥è°ƒç”¨AIæ¨¡å‹</strong>ï¼šåº”è¯¥é€šè¿‡Serviceå±‚å°è£…</li>
                        <li>â€¢ <strong>ç¡¬ç¼–ç APIå¯†é’¥</strong>ï¼šåº”ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ç®¡ç†æœåŠ¡</li>
                        <li>â€¢ <strong>Serviceä¹‹é—´å¾ªç¯ä¾èµ–</strong>ï¼šé€šè¿‡å…±äº«Serviceæˆ–äº‹ä»¶æœºåˆ¶è§£è€¦</li>
                        <li>â€¢ <strong>å¼‚å¸¸åæ‰æˆ–ç›´æ¥è¿”å›</strong>ï¼šåº”è¯¥è®°å½•æ—¥å¿—å¹¶è½¬æ¢ä¸ºé€‚å½“çš„é”™è¯¯å“åº”</li>
                    </ul>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">1.2 æœåŠ¡æ‹†åˆ†ç¤ºä¾‹</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">ChatService.java</div>
                        <div class="text-xs text-gray-400">æœåŠ¡æ¥å£å®šä¹‰</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service.chat;

import com.example.langchain4j.model.dto.ChatRequest;
import com.example.langchain4j.model.dto.ChatResponse;

/**
 * èŠå¤©æœåŠ¡æ¥å£
 * å®šä¹‰èŠå¤©ç›¸å…³çš„ä¸šåŠ¡æ“ä½œ
 */
public interface ChatService {

    /**
     * å‘é€èŠå¤©æ¶ˆæ¯
     * @param request èŠå¤©è¯·æ±‚
     * @return èŠå¤©å“åº”
     */
    ChatResponse chat(ChatRequest request);

    /**
     * æµå¼èŠå¤©
     * @param request èŠå¤©è¯·æ±‚
     * @return æµå¼å“åº”
     */
    Flux&lt;ChatResponse&gt; chatStream(ChatRequest request);

    /**
     * æ¸…é™¤å¯¹è¯å†å²
     * @param sessionId ä¼šè¯ID
     */
    void clearHistory(String sessionId);
}
                    </code></pre>
                </div>

                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">ChatServiceImpl.java</div>
                        <div class="text-xs text-gray-400">æœåŠ¡å®ç°</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service.chat.impl;

import com.example.langchain4j.model.dto.ChatRequest;
import com.example.langchain4j.model.dto.ChatResponse;
import com.example.langchain4j.service.ai.AiAgent;
import com.example.langchain4j.service.chat.ChatService;
import com.example.langchain4j.service.ai.MemoryService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;

/**
 * èŠå¤©æœåŠ¡å®ç°
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class ChatServiceImpl implements ChatService {

    private final AiAgent aiAgent;
    private final MemoryService memoryService;

    @Override
    public ChatResponse chat(ChatRequest request) {
        log.debug("å¤„ç†èŠå¤©è¯·æ±‚: sessionId={}, user={}",
            request.getSessionId(), request.getUserId());

        try {
            // 1. è·å–å†å²å¯¹è¯ä¸Šä¸‹æ–‡
            String context = memoryService.getContext(request.getSessionId());

            // 2. è°ƒç”¨AIç”Ÿæˆå“åº”
            String response = aiAgent.generate(
                request.getMessage(),
                context,
                request.getModel()
            );

            // 3. ä¿å­˜å¯¹è¯å†å²
            memoryService.saveMessage(
                request.getSessionId(),
                request.getUserId(),
                request.getMessage(),
                response
            );

            // 4. æ„å»ºå“åº”
            return ChatResponse.builder()
                .sessionId(request.getSessionId())
                .message(response)
                .model(request.getModel())
                .timestamp(System.currentTimeMillis())
                .build();

        } catch (Exception e) {
            log.error("èŠå¤©å¤„ç†å¤±è´¥: sessionId={}", request.getSessionId(), e);
            throw new ChatException("AIå¤„ç†å¤±è´¥", e);
        }
    }

    @Override
    public Flux&lt;ChatResponse&gt; chatStream(ChatRequest request) {
        log.debug("å¤„ç†æµå¼èŠå¤©è¯·æ±‚: sessionId={}", request.getSessionId());

        try {
            // 1. è·å–å†å²å¯¹è¯ä¸Šä¸‹æ–‡
            String context = memoryService.getContext(request.getSessionId());

            // 2. è°ƒç”¨æµå¼AIç”Ÿæˆ
            Flux&lt;String&gt; responseStream = aiAgent.generateStream(
                request.getMessage(),
                context,
                request.getModel()
            );

            // 3. è½¬æ¢ä¸ºå“åº”æµå¹¶ä¿å­˜å†å²
            return responseStream
                .map(chunk -&gt; ChatResponse.builder()
                    .sessionId(request.getSessionId())
                    .message(chunk)
                    .model(request.getModel())
                    .timestamp(System.currentTimeMillis())
                    .build()
                )
                .doOnComplete(() -&gt; {
                    // æµç»“æŸåä¿å­˜å®Œæ•´å¯¹è¯
                    String fullResponse = collectFullResponse(responseStream);
                    memoryService.saveMessage(
                        request.getSessionId(),
                        request.getUserId(),
                        request.getMessage(),
                        fullResponse
                    );
                });

        } catch (Exception e) {
            log.error("æµå¼èŠå¤©å¤„ç†å¤±è´¥", e);
            return Flux.error(new ChatException("æµå¼å¤„ç†å¤±è´¥", e));
        }
    }

    @Override
    public void clearHistory(String sessionId) {
        log.info("æ¸…é™¤å¯¹è¯å†å²: sessionId={}", sessionId);
        memoryService.clear(sessionId);
    }

    private String collectFullResponse(Flux&lt;String&gt; stream) {
        // ç®€åŒ–å®ç°ï¼šæ”¶é›†æ‰€æœ‰chunk
        return stream.collectList().block().stream()
            .reduce("", (a, b) -&gt; a + b);
    }
}
                    </code></pre>
                </div>
            </section>

            <section class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <span class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">2</span>
                    æ€§èƒ½ä¼˜åŒ–
                </h2>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">2.1 è¿æ¥æ± ç®¡ç†</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">HttpClientConfig.java</div>
                        <div class="text-xs text-gray-400">HTTPè¿æ¥æ± é…ç½®</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.config;

import dev.langchain4j.model.openai.OpenAiChatModel;
import okhttp3.ConnectionPool;
import okhttp3.OkHttpClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.TimeUnit;

/**
 * HTTPå®¢æˆ·ç«¯é…ç½®
 * ä¼˜åŒ–OpenAI APIè°ƒç”¨æ€§èƒ½
 */
@Configuration
public class HttpClientConfig {

    @Value("${openai.api.timeout.connect:10}")
    private int connectTimeout;

    @Value("${openai.api.timeout.read:60}")
    private int readTimeout;

    @Value("${openai.api.timeout.write:30}")
    private int writeTimeout;

    @Value("${openai.api.connection-pool.max-idle:5}")
    private int maxIdleConnections;

    @Value("${openai.api.connection-pool.keep-alive:300}")
    private long keepAliveDuration;

    /**
     * é…ç½®OkHttpClientè¿æ¥æ± 
     * æå‡HTTPè¯·æ±‚æ€§èƒ½
     */
    @Bean
    public OkHttpClient okHttpClient() {
        return new OkHttpClient.Builder()
            .connectionPool(new ConnectionPool(
                maxIdleConnections,      // æœ€å¤§ç©ºé—²è¿æ¥æ•°
                keepAliveDuration,        // ä¿æŒå­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰
                TimeUnit.SECONDS
            ))
            .connectTimeout(connectTimeout, TimeUnit.SECONDS)
            .readTimeout(readTimeout, TimeUnit.SECONDS)
            .writeTimeout(writeTimeout, TimeUnit.SECONDS)
            // æ·»åŠ é‡è¯•æ‹¦æˆªå™¨
            .addInterceptor(new RetryInterceptor())
            // æ·»åŠ æ—¥å¿—æ‹¦æˆªå™¨
            .addInterceptor(new LoggingInterceptor())
            .build();
    }

    /**
     * ä½¿ç”¨è¿æ¥æ± é…ç½®çš„èŠå¤©æ¨¡å‹
     */
    @Bean
    public OpenAiChatModel chatLanguageModel(OkHttpClient httpClient) {
        return OpenAiChatModel.builder()
            .apiKey(System.getenv("OPENAI_API_KEY"))
            .modelName("gpt-4")
            .temperature(0.7)
            .maxTokens(1000)
            .timeout(Duration.ofSeconds(readTimeout))
            .client(httpClient)  // ä½¿ç”¨è‡ªå®šä¹‰HTTPå®¢æˆ·ç«¯
            .build();
    }
}

/**
 * é‡è¯•æ‹¦æˆªå™¨
 * è‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚
 */
class RetryInterceptor implements Interceptor {
    private static final int MAX_RETRIES = 3;
    private static final long RETRY_DELAY_MS = 1000;

    @Override
    public Response intercept(Chain chain) throws IOException {
        Request request = chain.request();
        IOException lastException = null;

        for (int i = 0; i &lt;= MAX_RETRIES; i++) {
            try {
                Response response = chain.proceed(request);
                if (response.isSuccessful()) {
                    return response;
                }
                response.close();
            } catch (IOException e) {
                lastException = e;
                if (i &lt; MAX_RETRIES) {
                    try {
                        Thread.sleep(RETRY_DELAY_MS);
                    } catch (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                        throw new IOException("é‡è¯•è¢«ä¸­æ–­", ie);
                    }
                }
            }
        }

        throw new IOException("è¯·æ±‚å¤±è´¥ï¼Œå·²é‡è¯•" + MAX_RETRIES + "æ¬¡", lastException);
    }
}

/**
 * æ—¥å¿—æ‹¦æˆªå™¨
 * è®°å½•APIè¯·æ±‚å’Œå“åº”
 */
class LoggingInterceptor implements Interceptor {
    private static final Logger logger = LoggerFactory.getLogger(LoggingInterceptor.class);

    @Override
    public Response intercept(Chain chain) throws IOException {
        Request request = chain.request();

        long startTime = System.currentTimeMillis();
        logger.debug("APIè¯·æ±‚: {} {}", request.method(), request.url());

        try {
            Response response = chain.proceed(request);
            long duration = System.currentTimeMillis() - startTime;

            logger.debug("APIå“åº”: {} - çŠ¶æ€ç : {}, è€—æ—¶: {}ms",
                request.url(), response.code(), duration);

            return response;
        } catch (IOException e) {
            long duration = System.currentTimeMillis() - startTime;
            logger.error("APIè¯·æ±‚å¤±è´¥: {} - è€—æ—¶: {}ms, é”™è¯¯: {}",
                request.url(), duration, e.getMessage());
            throw e;
        }
    }
}
                    </code></pre>
                </div>

                <div class="bg-blue-50 border border-blue-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-blue-600">ğŸ’¡</span> æ€§èƒ½ä¼˜åŒ–è¦ç‚¹
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>è¿æ¥å¤ç”¨</strong>ï¼šä½¿ç”¨è¿æ¥æ± é¿å…é¢‘ç¹å»ºç«‹HTTPè¿æ¥</li>
                        <li>â€¢ <strong>è¶…æ—¶é…ç½®</strong>ï¼šåˆç†è®¾ç½®è¿æ¥ã€è¯»å–ã€å†™å…¥è¶…æ—¶</li>
                        <li>â€¢ <strong>è‡ªåŠ¨é‡è¯•</strong>ï¼šå¯¹ä¸´æ—¶æ€§é”™è¯¯ï¼ˆå¦‚ç½‘ç»œæŠ–åŠ¨ï¼‰è‡ªåŠ¨é‡è¯•</li>
                        <li>â€¢ <strong>æ—¥å¿—è®°å½•</strong>ï¼šè®°å½•APIè°ƒç”¨è€—æ—¶ï¼Œä¾¿äºæ€§èƒ½åˆ†æ</li>
                        <li>â€¢ <strong>è¿æ¥ä¿æ´»</strong>ï¼šè®¾ç½®åˆç†çš„keep-aliveæ—¶é—´</li>
                    </ul>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">2.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">BatchEmbeddingService.java</div>
                        <div class="text-xs text-gray-400">æ‰¹é‡EmbeddingæœåŠ¡</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service.rag;

import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.stream.Collectors;

/**
 * æ‰¹é‡EmbeddingæœåŠ¡
 * ä¼˜åŒ–å¤§æ‰¹é‡æ–‡æ¡£çš„å‘é‡åŒ–å¤„ç†
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class BatchEmbeddingService {

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore&lt;TextSegment&gt; embeddingStore;

    // å¹¶å‘å¤„ç†çº¿ç¨‹æ± 
    private static final int BATCH_SIZE = 100;          // æ¯æ‰¹å¤„ç†æ•°é‡
    private static final int PARALLEL_THREADS = 4;       // å¹¶å‘çº¿ç¨‹æ•°

    private final ExecutorService executor = Executors.newFixedThreadPool(PARALLEL_THREADS);

    /**
     * æ‰¹é‡ç”ŸæˆEmbeddingå¹¶å­˜å‚¨
     * @param segments æ–‡æœ¬ç‰‡æ®µåˆ—è¡¨
     */
    public void batchEmbedAndStore(List&lt;TextSegment&gt; segments) {
        log.info("å¼€å§‹æ‰¹é‡å¤„ç†Embedding: æ€»æ•°={}", segments.size());
        long startTime = System.currentTimeMillis();

        // 1. åˆ†æ‰¹å¤„ç†
        List&lt;List&lt;TextSegment&gt;&gt; batches = partition(segments, BATCH_SIZE);

        // 2. å¹¶å‘å¤„ç†æ¯æ‰¹
        List&lt;CompletableFuture&lt;Void&gt;&gt; futures = batches.stream()
            .map(batch -&gt; CompletableFuture.runAsync(() -&gt; {
                try {
                    processBatch(batch);
                } catch (Exception e) {
                    log.error("æ‰¹æ¬¡å¤„ç†å¤±è´¥: size={}", batch.size(), e);
                    throw new RuntimeException(e);
                }
            }, executor))
            .collect(Collectors.toList());

        // 3. ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();

        long duration = System.currentTimeMillis() - startTime;
        log.info("æ‰¹é‡å¤„ç†å®Œæˆ: æ€»æ•°={}, è€—æ—¶={}ms, å¹³å‡={}ms/æ¡",
            segments.size(), duration, duration / segments.size());
    }

    /**
     * å¤„ç†å•ä¸ªæ‰¹æ¬¡
     */
    private void processBatch(List&lt;TextSegment&gt; batch) {
        log.debug("å¤„ç†æ‰¹æ¬¡: size={}", batch.size());

        // 1. æ‰¹é‡ç”ŸæˆEmbedding
        List&lt;Embedding&gt; embeddings = embeddingModel.embedAll(batch).content();

        // 2. æ‰¹é‡å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
        for (int i = 0; i &lt; batch.size(); i++) {
            TextSegment segment = batch.get(i);
            Embedding embedding = embeddings.get(i);

            embeddingStore.add(
                idFor(segment),
                embedding,
                segment
            );
        }

        log.debug("æ‰¹æ¬¡å¤„ç†å®Œæˆ: size={}", batch.size());
    }

    /**
     * åˆ†åŒºå‡½æ•°
     */
    private &lt;T&gt; List&lt;List&lt;T&gt;&gt; partition(List&lt;T&gt; list, int batchSize) {
        List&lt;List&lt;T&gt;&gt; result = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; list.size(); i += batchSize) {
            result.add(list.subList(i, Math.min(i + batchSize, list.size())));
        }
        return result;
    }

    /**
     * ç”Ÿæˆå”¯ä¸€ID
     */
    private String idFor(TextSegment segment) {
        return segment.text().hashCode() + "";
    }

    /**
     * å…³é—­çº¿ç¨‹æ± 
     */
    @PreDestroy
    public void shutdown() {
        executor.shutdown();
    }
}
                    </code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">2.3 ç¼“å­˜ç­–ç•¥</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">CacheConfig.java</div>
                        <div class="text-xs text-gray-400">ç¼“å­˜é…ç½®</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.config;

import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.cache.RedisCacheConfiguration;
import org.springframework.data.redis.cache.RedisCacheManager;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializationContext;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.time.Duration;

/**
 * ç¼“å­˜é…ç½®
 * ä½¿ç”¨Redisä½œä¸ºç¼“å­˜åç«¯
 */
@Configuration
@EnableCaching
public class CacheConfig {

    /**
     * ç¼“å­˜ç®¡ç†å™¨é…ç½®
     */
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            // ç¼“å­˜è¿‡æœŸæ—¶é—´
            .entryTtl(Duration.ofHours(1))
            // Keyåºåˆ—åŒ–
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            // Valueåºåˆ—åŒ–ï¼ˆJSONï¼‰
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()))
            // ç¦ç”¨ç¼“å­˜nullå€¼
            .disableCachingNullValues();

        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            // é’ˆå¯¹ä¸åŒç¼“å­˜è®¾ç½®ä¸åŒè¿‡æœŸæ—¶é—´
            .withCacheConfiguration("embedding", config.entryTtl(Duration.ofDays(7)))
            .withCacheConfiguration("chat", config.entryTtl(Duration.ofHours(2)))
            .withCacheConfiguration("rag", config.entryTtl(Duration.ofMinutes(30)))
            .transactionAware()
            .build();
    }
}

/**
 * å¸¦ç¼“å­˜çš„æœåŠ¡ç¤ºä¾‹
 */
@Service
public class CachedRagService {

    private final EmbeddingStore&lt;TextSegment&gt; embeddingStore;
    private final EmbeddingModel embeddingModel;

    /**
     * æ£€ç´¢ç›¸å…³æ–‡æ¡£ï¼ˆå¸¦ç¼“å­˜ï¼‰
     * ç¼“å­˜key: "rag:query:{queryçš„hash}"
     * ç¼“å­˜æ—¶é•¿: 30åˆ†é’Ÿ
     */
    @Cacheable(
        value = "rag",
        key = "'query:' + #query.hashCode()",
        unless = "#result.isEmpty()"
    )
    public List&lt;TextSegment&gt; retrieve(String query, int topK) {
        log.debug("æ‰§è¡ŒRAGæ£€ç´¢: query={}, topK={}", query, topK);

        // 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
        Embedding queryEmbedding = embeddingModel.embed(query).content();

        // 2. æ£€ç´¢ç›¸å…³æ–‡æ¡£
        List&lt;EmbeddingMatch&lt;TextSegment&gt;&gt; matches = embeddingStore.findRelevant(
            queryEmbedding,
            topK,
            0.7  // ç›¸ä¼¼åº¦é˜ˆå€¼
        );

        // 3. è¿”å›åŒ¹é…çš„æ–‡æ¡£
        return matches.stream()
            .filter(match -&gt; match.score() &gt;= 0.7)
            .map(EmbeddingMatch::embedded)
            .collect(Collectors.toList());
    }

    /**
     * æ¸…é™¤ç¼“å­˜
     */
    @CacheEvict(value = "rag", allEntries = true)
    public void clearCache() {
        log.info("æ¸…é™¤RAGç¼“å­˜");
    }
}
                    </code></pre>
                </div>

                <div class="bg-green-50 border border-green-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-green-600">âœ…</span> ç¼“å­˜æœ€ä½³å®è·µ
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>åˆ†çº§ç¼“å­˜</strong>ï¼šEmbeddingç»“æœç¼“å­˜7å¤©ï¼ŒRAGæ£€ç´¢ç¼“å­˜30åˆ†é’Ÿï¼Œå¯¹è¯ç¼“å­˜2å°æ—¶</li>
                        <li>â€¢ <strong>åˆç†TTL</strong>ï¼šæ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è®¾ç½®åˆé€‚çš„è¿‡æœŸæ—¶é—´</li>
                        <li>â€¢ <strong>é¿å…ç¼“å­˜é›ªå´©</strong>ï¼šè®¾ç½®éšæœºTTLæŠ–åŠ¨</li>
                        <li>â€¢ <strong>ç¼“å­˜ç©¿é€ä¿æŠ¤</strong>ï¼šä½¿ç”¨unlesså‚æ•°é¿å…ç¼“å­˜ç©ºå€¼</li>
                        <li>â€¢ <strong>å¼‚æ­¥åˆ·æ–°</strong>ï¼šä½¿ç”¨@CachePutåœ¨åå°æ›´æ–°ç¼“å­˜</li>
                    </ul>
                </div>
            </section>

            <section class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <span class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">3</span>
                    é”™è¯¯å¤„ç†å’Œå®¹é”™
                </h2>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">3.1 å¼‚å¸¸åˆ†ç±»å’Œå¤„ç†</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">AiException.java</div>
                        <div class="text-xs text-gray-400">AIå¼‚å¸¸åŸºç±»</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.exception;

import lombok.Getter;

/**
 * AIå¼‚å¸¸åŸºç±»
 */
@Getter
public class AiException extends RuntimeException {

    private final String errorCode;
    private final boolean retryable;

    public AiException(String message) {
        super(message);
        this.errorCode = "AI_ERROR";
        this.retryable = false;
    }

    public AiException(String message, Throwable cause) {
        super(message, cause);
        this.errorCode = "AI_ERROR";
        this.retryable = isRetryable(cause);
    }

    public AiException(String errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
        this.retryable = false;
    }

    public AiException(String errorCode, String message, boolean retryable) {
        super(message);
        this.errorCode = errorCode;
        this.retryable = retryable;
    }

    /**
     * åˆ¤æ–­å¼‚å¸¸æ˜¯å¦å¯é‡è¯•
     */
    private boolean isRetryable(Throwable cause) {
        if (cause == null) return false;

        String message = cause.getMessage();
        if (message == null) return false;

        // å¯é‡è¯•çš„é”™è¯¯
        if (message.contains("timeout") ||
            message.contains("connection") ||
            message.contains("503") ||
            message.contains("429")) {
            return true;
        }

        return false;
    }
}

/**
 * APIå¯†é’¥å¼‚å¸¸
 */
class ApiKeyException extends AiException {
    public ApiKeyException() {
        super("API_KEY_MISSING", "APIå¯†é’¥æœªé…ç½®");
    }
}

/**
 * é…é¢è¶…é™å¼‚å¸¸
 */
class QuotaExceededException extends AiException {
    public QuotaExceededException(String message) {
        super("QUOTA_EXCEEDED", message, false);
    }
}

/**
 * æ¨¡å‹ä¸å¯ç”¨å¼‚å¸¸
 */
class ModelUnavailableException extends AiException {
    public ModelUnavailableException(String modelName) {
        super("MODEL_UNAVAILABLE", "æ¨¡å‹ä¸å¯ç”¨: " + modelName, true);
    }
}

/**
 * å†…å®¹å®¡æ ¸å¤±è´¥å¼‚å¸¸
 */
class ModerationException extends AiException {
    public ModerationException(String reason) {
        super("MODERATION_FAILED", "å†…å®¹å®¡æ ¸å¤±è´¥: " + reason, false);
    }
}
                    </code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">3.2 å…¨å±€å¼‚å¸¸å¤„ç†</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">GlobalExceptionHandler.java</div>
                        <div class="text-xs text-gray-400">å…¨å±€å¼‚å¸¸å¤„ç†å™¨</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.exception;

import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 * ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¼‚å¸¸ï¼Œè¿”å›æ ‡å‡†åŒ–é”™è¯¯å“åº”
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * å¤„ç†AIå¼‚å¸¸
     */
    @ExceptionHandler(AiException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleAiException(AiException e) {
        log.error("AIå¼‚å¸¸: {} - {}", e.getErrorCode(), e.getMessage(), e);

        HttpStatus status = e.isRetryable()
            ? HttpStatus.SERVICE_UNAVAILABLE
            : HttpStatus.BAD_REQUEST;

        return ResponseEntity.status(status)
            .body(ErrorResponse.builder()
                .timestamp(LocalDateTime.now())
                .status(status.value())
                .error(status.getReasonPhrase())
                .message(e.getMessage())
                .code(e.getErrorCode())
                .retryable(e.isRetryable())
                .build());
    }

    /**
     * å¤„ç†APIå¯†é’¥å¼‚å¸¸
     */
    @ExceptionHandler(ApiKeyException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleApiKeyException(ApiKeyException e) {
        log.error("APIå¯†é’¥å¼‚å¸¸", e);

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(ErrorResponse.builder()
                .timestamp(LocalDateTime.now())
                .status(500)
                .error("Configuration Error")
                .message("APIå¯†é’¥æœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
                .code("API_KEY_MISSING")
                .retryable(false)
                .build());
    }

    /**
     * å¤„ç†é…é¢è¶…é™å¼‚å¸¸
     */
    @ExceptionHandler(QuotaExceededException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleQuotaExceededException(QuotaExceededException e) {
        log.warn("é…é¢è¶…é™: {}", e.getMessage());

        return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)
            .body(ErrorResponse.builder()
                .timestamp(LocalDateTime.now())
                .status(429)
                .error("Too Many Requests")
                .message(e.getMessage())
                .code("QUOTA_EXCEEDED")
                .retryable(true)
                .build());
    }

    /**
     * å¤„ç†å†…å®¹å®¡æ ¸å¼‚å¸¸
     */
    @ExceptionHandler(ModerationException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleModerationException(ModerationException e) {
        log.warn("å†…å®¹å®¡æ ¸å¤±è´¥: {}", e.getMessage());

        return ResponseEntity.status(HttpStatus.FORBIDDEN)
            .body(ErrorResponse.builder()
                .timestamp(LocalDateTime.now())
                .status(403)
                .error("Content Moderation")
                .message(e.getMessage())
                .code("MODERATION_FAILED")
                .retryable(false)
                .build());
    }

    /**
     * å¤„ç†å…¶ä»–æœªæ•è·å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleGenericException(Exception e) {
        log.error("æœªæ•è·å¼‚å¸¸", e);

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(ErrorResponse.builder()
                .timestamp(LocalDateTime.now())
                .status(500)
                .error("Internal Server Error")
                .message("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•")
                .code("INTERNAL_ERROR")
                .retryable(true)
                .build());
    }
}

/**
 * æ ‡å‡†é”™è¯¯å“åº”
 */
@Data
@Builder
class ErrorResponse {
    private LocalDateTime timestamp;
    private int status;
    private String error;
    private String message;
    private String code;
    private boolean retryable;
}
                    </code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">3.3 é‡è¯•æœºåˆ¶</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">RetryTemplate.java</div>
                        <div class="text-xs text-gray-400">é‡è¯•æ¨¡æ¿</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.util;

import lombok.extern.slf4j.Slf4j;

import java.util.function.Supplier;

/**
 * é‡è¯•æ¨¡æ¿
 * æä¾›å¯é…ç½®çš„é‡è¯•æœºåˆ¶
 */
@Slf4j
public class RetryTemplate {

    private final int maxAttempts;
    private final long delayMs;
    private final double backoffMultiplier;

    public RetryTemplate(int maxAttempts, long delayMs, double backoffMultiplier) {
        this.maxAttempts = maxAttempts;
        this.delayMs = delayMs;
        this.backoffMultiplier = backoffMultiplier;
    }

    /**
     * æ‰§è¡Œå¸¦é‡è¯•çš„æ“ä½œ
     * @param operation è¦æ‰§è¡Œçš„æ“ä½œ
     * @param &lt;T&gt; è¿”å›ç±»å‹
     * @return æ“ä½œç»“æœ
     */
    public &lt;T&gt; T execute(Supplier&lt;T&gt; operation) {
        int attempt = 0;
        long currentDelay = delayMs;
        Exception lastException = null;

        while (attempt &lt; maxAttempts) {
            attempt++;

            try {
                log.debug("æ‰§è¡Œæ“ä½œ: attempt={}/{}", attempt, maxAttempts);
                T result = operation.get();
                if (attempt &gt; 1) {
                    log.info("é‡è¯•æˆåŠŸ: attempt={}/{}", attempt, maxAttempts);
                }
                return result;

            } catch (Exception e) {
                lastException = e;
                log.warn("æ“ä½œå¤±è´¥: attempt={}/{}, error={}",
                    attempt, maxAttempts, e.getMessage());

                if (attempt &lt; maxAttempts) {
                    try {
                        Thread.sleep(currentDelay);
                        currentDelay *= backoffMultiplier;
                    } catch (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                        throw new RuntimeException("é‡è¯•è¢«ä¸­æ–­", ie);
                    }
                }
            }
        }

        log.error("é‡è¯•å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§å°è¯•æ¬¡æ•°: {}", maxAttempts);
        throw new RuntimeException(
            String.format("æ“ä½œå¤±è´¥ï¼Œå·²é‡è¯•%dæ¬¡", maxAttempts),
            lastException
        );
    }

    /**
     * é»˜è®¤é‡è¯•æ¨¡æ¿
     * æœ€å¤šé‡è¯•3æ¬¡ï¼Œåˆå§‹å»¶è¿Ÿ1ç§’ï¼ŒæŒ‡æ•°é€€é¿
     */
    public static RetryTemplate defaultRetry() {
        return new RetryTemplate(3, 1000, 2.0);
    }

    /**
     * å¿«é€Ÿå¤±è´¥æ¨¡æ¿
     * ä¸é‡è¯•
     */
    public static RetryTemplate noRetry() {
        return new RetryTemplate(1, 0, 1.0);
    }

    /**
     * æ¿€è¿›é‡è¯•æ¨¡æ¿
     * æœ€å¤šé‡è¯•5æ¬¡ï¼Œåˆå§‹å»¶è¿Ÿ500ms
     */
    public static RetryTemplate aggressiveRetry() {
        return new RetryTemplate(5, 500, 1.5);
    }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
@Service
public class AiServiceWithRetry {

    private final AiAgent aiAgent;
    private final RetryTemplate retryTemplate = RetryTemplate.defaultRetry();

    public String generateResponse(String prompt) {
        return retryTemplate.execute(() -&gt; aiAgent.generate(prompt));
    }
}
                    </code></pre>
                </div>

                <div class="bg-amber-50 border border-amber-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-amber-600">âš ï¸</span> å®¹é”™è®¾è®¡è¦ç‚¹
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>ä¼˜é›…é™çº§</strong>ï¼šAIæœåŠ¡ä¸å¯ç”¨æ—¶è¿”å›ç¼“å­˜ç»“æœæˆ–é»˜è®¤å›å¤</li>
                        <li>â€¢ <strong>ç†”æ–­æœºåˆ¶</strong>ï¼šè¿ç»­å¤±è´¥æ—¶æš‚æ—¶åœæ­¢è°ƒç”¨ï¼Œé¿å…é›ªå´©</li>
                        <li>â€¢ <strong>è¶…æ—¶æ§åˆ¶</strong>ï¼šæ‰€æœ‰å¤–éƒ¨è°ƒç”¨å¿…é¡»è®¾ç½®è¶…æ—¶</li>
                        <li>â€¢ <strong>èµ„æºéš”ç¦»</strong>ï¼šä¸åŒç§Ÿæˆ·æˆ–æ¨¡å‹ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± </li>
                        <li>â€¢ <strong>ç›‘æ§å‘Šè­¦</strong>ï¼šç›‘æ§å¤±è´¥ç‡ã€å»¶è¿Ÿç­‰æŒ‡æ ‡</li>
                    </ul>
                </div>
            </section>

            <section class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <span class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">4</span>
                    å®‰å…¨å®è·µ
                </h2>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">4.1 APIå¯†é’¥ç®¡ç†</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">ApiKeyManager.java</div>
                        <div class="text-xs text-gray-400">å¯†é’¥ç®¡ç†å™¨</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * APIå¯†é’¥ç®¡ç†å™¨
 * æ”¯æŒå¤šç§Ÿæˆ·ã€è½®è¯¢ã€è´Ÿè½½å‡è¡¡
 */
@Slf4j
@Service
public class ApiKeyManager {

    @Value("${openai.api.keys:}")
    private String apiKeysConfig;

    @Value("${openai.api.rotation.enabled:false}")
    private boolean rotationEnabled;

    private Map&lt;String, ApiKeyInfo&gt; tenantKeys = new ConcurrentHashMap&lt;&gt;();
    private Map&lt;String, ApiKeyInfo&gt; globalKeys = new ConcurrentHashMap&lt;&gt;();

    private int currentKeyIndex = 0;

    @PostConstruct
    public void init() {
        // ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶åŠ è½½å¯†é’¥
        loadApiKeys();
        log.info("APIå¯†é’¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ: å…¨å±€å¯†é’¥æ•°={}", globalKeys.size());
    }

    /**
     * è·å–APIå¯†é’¥ï¼ˆå…¨å±€ï¼‰
     * æ”¯æŒè½®è¯¢ä»¥åˆ†æ•£é…é¢
     */
    public String getApiKey() {
        if (globalKeys.isEmpty()) {
            throw new ApiKeyException("æœªé…ç½®å…¨å±€APIå¯†é’¥");
        }

        if (rotationEnabled) {
            // è½®è¯¢å¯†é’¥
            ApiKeyInfo keyInfo = getNextAvailableKey(globalKeys);
            if (keyInfo == null) {
                throw new ApiKeyException("æ‰€æœ‰APIå¯†é’¥é…é¢å·²ç”¨å°½");
            }
            return keyInfo.getKey();
        } else {
            // è¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨å¯†é’¥
            return globalKeys.values().stream()
                .filter(ApiKeyInfo::isAvailable)
                .findFirst()
                .map(ApiKeyInfo::getKey)
                .orElseThrow(() -&gt; new ApiKeyException("æ‰€æœ‰APIå¯†é’¥é…é¢å·²ç”¨å°½"));
        }
    }

    /**
     * è·å–ç§Ÿæˆ·çš„APIå¯†é’¥
     */
    public String getApiKey(String tenantId) {
        ApiKeyInfo keyInfo = tenantKeys.get(tenantId);
        if (keyInfo == null) {
            log.warn("ç§Ÿæˆ·{}æœªé…ç½®ä¸“ç”¨å¯†é’¥ï¼Œä½¿ç”¨å…¨å±€å¯†é’¥", tenantId);
            return getApiKey();
        }

        if (!keyInfo.isAvailable()) {
            log.warn("ç§Ÿæˆ·{}çš„APIå¯†é’¥é…é¢å·²ç”¨å°½", tenantId);
            throw new QuotaExceededException("é…é¢å·²ç”¨å°½");
        }

        return keyInfo.getKey();
    }

    /**
     * æ ‡è®°å¯†é’¥é…é¢å·²ç”¨å°½
     */
    public void markQuotaExceeded(String apiKey) {
        log.warn("APIå¯†é’¥é…é¢å·²ç”¨å°½: {}", maskApiKey(apiKey));

        globalKeys.values().stream()
            .filter(k -&gt; k.getKey().equals(apiKey))
            .forEach(k -&gt; k.setAvailable(false));

        tenantKeys.values().stream()
            .filter(k -&gt; k.getKey().equals(apiKey))
            .forEach(k -&gt; k.setAvailable(false));
    }

    /**
     * æ£€æŸ¥å¯†é’¥çŠ¶æ€
     */
    public void checkKeyStatus() {
        globalKeys.values().forEach(this::checkKeyHealth);
        tenantKeys.values().forEach(this::checkKeyHealth);
    }

    /**
     * é‡ç½®å¯†é’¥çŠ¶æ€
     */
    public void resetKeys() {
        globalKeys.values().forEach(k -&gt; k.setAvailable(true));
        tenantKeys.values().forEach(k -&gt; k.setAvailable(true));
        log.info("æ‰€æœ‰APIå¯†é’¥çŠ¶æ€å·²é‡ç½®");
    }

    // ========== ç§æœ‰æ–¹æ³• ==========

    private void loadApiKeys() {
        // ä»ç¯å¢ƒå˜é‡åŠ è½½
        String envKey = System.getenv("OPENAI_API_KEY");
        if (envKey != null &amp;&amp; !envKey.isEmpty()) {
            addGlobalKey(envKey);
        }

        // ä»é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆæ”¯æŒå¤šä¸ªå¯†é’¥ï¼Œé€—å·åˆ†éš”ï¼‰
        if (apiKeysConfig != null &amp;&amp; !apiKeysConfig.isEmpty()) {
            String[] keys = apiKeysConfig.split(",");
            for (String key : keys) {
                String trimmedKey = key.trim();
                if (!trimmedKey.isEmpty()) {
                    addGlobalKey(trimmedKey);
                }
            }
        }
    }

    private void addGlobalKey(String key) {
        String keyId = generateKeyId(key);
        globalKeys.put(keyId, new ApiKeyInfo(keyId, key));
        log.debug("æ·»åŠ å…¨å±€APIå¯†é’¥: {}", maskApiKey(key));
    }

    private ApiKeyInfo getNextAvailableKey(Map&lt;String, ApiKeyInfo&gt; keys) {
        int size = keys.size();
        for (int i = 0; i &lt; size; i++) {
            int index = (currentKeyIndex + i) % size;
            ApiKeyInfo keyInfo = keys.get(index);
            if (keyInfo != null &amp;&amp; keyInfo.isAvailable()) {
                currentKeyIndex = index + 1;
                return keyInfo;
            }
        }
        return null;
    }

    private void checkKeyHealth(ApiKeyInfo keyInfo) {
        if (!keyInfo.isAvailable()) {
            // å¯ä»¥æ·»åŠ å®šæ—¶ä»»åŠ¡æ£€æŸ¥å¯†é’¥æ˜¯å¦æ¢å¤
            log.debug("å¯†é’¥ä¸å¯ç”¨: {}", maskApiKey(keyInfo.getKey()));
        }
    }

    private String generateKeyId(String key) {
        return "KEY-" + key.hashCode();
    }

    private String maskApiKey(String key) {
        if (key == null || key.length() &lt; 8) {
            return "****";
        }
        return key.substring(0, 4) + "****" + key.substring(key.length() - 4);
    }

    /**
     * APIå¯†é’¥ä¿¡æ¯
     */
    @Data
    static class ApiKeyInfo {
        private final String keyId;
        private final String key;
        private boolean available = true;
        private long lastUsedAt;
        private long quotaLimit;
        private long quotaUsed;

        public ApiKeyInfo(String keyId, String key) {
            this.keyId = keyId;
            this.key = key;
            this.lastUsedAt = System.currentTimeMillis();
        }

        public void markUsed() {
            this.lastUsedAt = System.currentTimeMillis();
            this.quotaUsed++;
        }
    }
}
                    </code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">4.2 è¾“å…¥éªŒè¯å’Œå†…å®¹è¿‡æ»¤</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">ContentValidator.java</div>
                        <div class="text-xs text-gray-400">å†…å®¹éªŒè¯å™¨</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.regex.Pattern;

/**
 * å†…å®¹éªŒè¯å™¨
 * éªŒè¯ç”¨æˆ·è¾“å…¥å’ŒAIè¾“å‡º
 */
@Slf4j
@Component
public class ContentValidator {

    // æ•æ„Ÿè¯åˆ—è¡¨
    private static final List&lt;String&gt; SENSITIVE_WORDS = List.of(
        "æš´åŠ›", "ææ€–", "è‰²æƒ…", "èµŒåš", "æ¯’å“"
    );

    // è¾“å…¥é•¿åº¦é™åˆ¶
    private static final int MAX_INPUT_LENGTH = 4000;
    private static final int MIN_INPUT_LENGTH = 1;

    // è¾“å‡ºé•¿åº¦é™åˆ¶
    private static final int MAX_OUTPUT_LENGTH = 10000;

    // å±é™©æ¨¡å¼
    private static final Pattern DANGEROUS_PATTERNS = Pattern.compile(
        "(?i)(system\\(|exec\\(|eval\\(|__import__|os\\.|subprocess\\.)"
    );

    /**
     * éªŒè¯ç”¨æˆ·è¾“å…¥
     * @param content è¾“å…¥å†…å®¹
     * @throws ValidationException éªŒè¯å¤±è´¥
     */
    public void validateInput(String content) {
        if (content == null || content.trim().isEmpty()) {
            throw new ValidationException("è¾“å…¥å†…å®¹ä¸èƒ½ä¸ºç©º");
        }

        if (content.length() &gt; MAX_INPUT_LENGTH) {
            throw new ValidationException(
                String.format("è¾“å…¥å†…å®¹è¿‡é•¿ï¼Œæœ€å¤§å…è®¸%dä¸ªå­—ç¬¦", MAX_INPUT_LENGTH)
            );
        }

        if (content.length() &lt; MIN_INPUT_LENGTH) {
            throw new ValidationException(
                String.format("è¾“å…¥å†…å®¹è¿‡çŸ­ï¼Œæœ€å°‘éœ€è¦%dä¸ªå­—ç¬¦", MIN_INPUT_LENGTH)
            );
        }

        // æ£€æŸ¥æ•æ„Ÿè¯
        for (String word : SENSITIVE_WORDS) {
            if (content.toLowerCase().contains(word.toLowerCase())) {
                log.warn("è¾“å…¥åŒ…å«æ•æ„Ÿè¯: {}", word);
                throw new ValidationException("è¾“å…¥å†…å®¹åŒ…å«æ•æ„Ÿè¯æ±‡");
            }
        }

        // æ£€æŸ¥å±é™©æ¨¡å¼
        if (DANGEROUS_PATTERNS.matcher(content).find()) {
            log.warn("è¾“å…¥åŒ…å«å±é™©æ¨¡å¼");
            throw new ValidationException("è¾“å…¥å†…å®¹åŒ…å«å±é™©ä»£ç æ¨¡å¼");
        }
    }

    /**
     * éªŒè¯AIè¾“å‡º
     * @param content AIç”Ÿæˆçš„å†…å®¹
     * @throws ValidationException éªŒè¯å¤±è´¥
     */
    public void validateOutput(String content) {
        if (content == null || content.trim().isEmpty()) {
            throw new ValidationException("AIè¾“å‡ºå†…å®¹ä¸ºç©º");
        }

        if (content.length() &gt; MAX_OUTPUT_LENGTH) {
            log.warn("AIè¾“å‡ºè¿‡é•¿ï¼Œæˆªæ–­å¤„ç†");
            content = content.substring(0, MAX_OUTPUT_LENGTH);
        }

        // å¯ä»¥æ·»åŠ æ›´å¤šçš„è¾“å‡ºéªŒè¯é€»è¾‘
        // ä¾‹å¦‚ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«æ¶æ„é“¾æ¥ã€æ•æ„Ÿä¿¡æ¯ç­‰
    }

    /**
     * æ¸…ç†è¾“å…¥å†…å®¹
     * @param content åŸå§‹å†…å®¹
     * @return æ¸…ç†åçš„å†…å®¹
     */
    public String sanitizeInput(String content) {
        // ç§»é™¤å¤šä½™ç©ºç™½
        content = content.trim().replaceAll("\\s+", " ");

        // ç§»é™¤æ§åˆ¶å­—ç¬¦
        content = content.replaceAll("[\\p{Cntrl}&&[^\\r\\n\\t]]", "");

        return content;
    }
}

/**
 * éªŒè¯å¼‚å¸¸
 */
class ValidationException extends RuntimeException {
    public ValidationException(String message) {
        super(message);
    }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
@Service
public class ChatServiceWithValidation {

    private final ContentValidator contentValidator;
    private final AiAgent aiAgent;

    public String chat(String userInput) {
        // éªŒè¯è¾“å…¥
        contentValidator.validateInput(userInput);

        // æ¸…ç†è¾“å…¥
        String sanitizedInput = contentValidator.sanitizeInput(userInput);

        // è°ƒç”¨AI
        String response = aiAgent.generate(sanitizedInput);

        // éªŒè¯è¾“å‡º
        contentValidator.validateOutput(response);

        return response;
    }
}
                    </code></pre>
                </div>

                <div class="bg-red-50 border border-red-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-red-600">ğŸ”’</span> å®‰å…¨æ³¨æ„äº‹é¡¹
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>å¯†é’¥ä¿æŠ¤</strong>ï¼šç»ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç APIå¯†é’¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡</li>
                        <li>â€¢ <strong>è¾“å…¥éªŒè¯</strong>ï¼šå¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯å’Œæ¸…ç†</li>
                        <li>â€¢ <strong>è¾“å‡ºè¿‡æ»¤</strong>ï¼šå¯¹AIè¾“å‡ºè¿›è¡Œå†…å®¹å®¡æ ¸</li>
                        <li>â€¢ <strong>æ•°æ®è„±æ•</strong>ï¼šæ—¥å¿—ä¸­ä¸è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚APIå¯†é’¥ã€ä¸ªäººä¿¡æ¯ï¼‰</li>
                        <li>â€¢ <strong>è®¿é—®æ§åˆ¶</strong>ï¼šå®ç°ç§Ÿæˆ·éš”ç¦»å’Œæƒé™æ§åˆ¶</li>
                        <li>â€¢ <strong>é€Ÿç‡é™åˆ¶</strong>ï¼šé˜²æ­¢APIæ»¥ç”¨å’ŒDDoSæ”»å‡»</li>
                    </ul>
                </div>
            </section>

            <section class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <span class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">5</span>
                    ç›‘æ§å’Œæ—¥å¿—
                </h2>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">5.1 æ—¥å¿—è®°å½•è§„èŒƒ</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">LoggingExample.java</div>
                        <div class="text-xs text-gray-400">æ—¥å¿—è®°å½•ç¤ºä¾‹</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

/**
 * æ—¥å¿—è®°å½•ç¤ºä¾‹
 */
@Slf4j
@Service
public class LoggingExampleService {

    /**
     * DEBUGçº§åˆ«ï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
     * åªåœ¨è°ƒè¯•æ—¶å¼€å¯
     */
    public void debugExample() {
        log.debug("å¤„ç†è¯·æ±‚: userId={}, sessionId={}", "user123", "session-456");
        log.debug("APIè°ƒç”¨: model={}, temperature={}, maxTokens={}",
            "gpt-4", 0.7, 1000);
    }

    /**
     * INFOçº§åˆ«ï¼šé‡è¦çš„ä¸šåŠ¡æ“ä½œ
     * è®°å½•å…³é”®æµç¨‹èŠ‚ç‚¹
     */
    public void infoExample(String userId) {
        log.info("ç”¨æˆ·å¼€å§‹èŠå¤©: userId={}", userId);
        log.info("æ–‡æ¡£ä¸Šä¼ æˆåŠŸ: userId={}, docName={}, size={}",
            userId, "document.pdf", 1024000);
        log.info("RAGæ£€ç´¢å®Œæˆ: query={}, topK={}, latency={}ms",
            "test query", 5, 150);
    }

    /**
     * WARNçº§åˆ«ï¼šå¯æ¢å¤çš„å¼‚å¸¸æƒ…å†µ
     * éœ€è¦å…³æ³¨ä½†ä¸å½±å“ç³»ç»Ÿè¿è¡Œ
     */
    public void warnExample(String userId) {
        log.warn("APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é‡è¯•: userId={}, error={}",
            userId, "timeout");
        log.warn("é…é¢ä½¿ç”¨è¶…è¿‡80%: tenantId={}, used={}, total={}",
            "tenant-123", 800, 1000);
        log.warn("ç¼“å­˜missï¼Œä»æ•°æ®åº“åŠ è½½: key={}", "cache-key");
    }

    /**
     * ERRORçº§åˆ«ï¼šé”™è¯¯å’Œå¼‚å¸¸
     * éœ€è¦ç«‹å³å¤„ç†çš„é—®é¢˜
     */
    public void errorExample(String userId, Exception e) {
        log.error("AIè°ƒç”¨å¤±è´¥: userId={}, model={}, error={}",
            userId, "gpt-4", e.getMessage(), e);
        log.error("æ•°æ®åº“è¿æ¥å¤±è´¥: {}", e.getMessage(), e);
        log.error("å‘é‡å­˜å‚¨å†™å…¥å¤±è´¥: docId={}, error={}",
            "doc-789", e.getMessage(), e);
    }

    /**
     * ç»“æ„åŒ–æ—¥å¿—
     * ä½¿ç”¨JSONæ ¼å¼ï¼Œä¾¿äºæ—¥å¿—åˆ†æ
     */
    public void structuredLog() {
        // æ–¹å¼1ï¼šä½¿ç”¨å ä½ç¬¦
        log.info("APIè°ƒç”¨æˆåŠŸ: model={}, latency={}ms, tokens={}",
            "gpt-4", 1250, 350);

        // æ–¹å¼2ï¼šä½¿ç”¨MDCï¼ˆMapped Diagnostic Contextï¼‰
        // MDC.put("userId", "user123");
        // MDC.put("sessionId", "session-456");
        // try {
        //     // ä¸šåŠ¡é€»è¾‘
        //     log.info("å¤„ç†å®Œæˆ");
        // } finally {
        //     MDC.clear();
        // }
    }

    /**
     * æ€§èƒ½æ—¥å¿—
     * è®°å½•å…³é”®æ“ä½œè€—æ—¶
     */
    public void performanceLog() {
        long startTime = System.currentTimeMillis();

        try {
            // æ‰§è¡Œè€—æ—¶æ“ä½œ
            Thread.sleep(100);
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            log.info("æ“ä½œå®Œæˆ: duration={}ms", duration);
        }
    }
}

/**
 * æ—¥å¿—é…ç½®ï¼ˆlogback.xmlï¼‰
 */
/*
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
    &lt;!-- æ§åˆ¶å°è¾“å‡º --&gt;
    &lt;appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- æ–‡ä»¶è¾“å‡ºï¼ˆæŒ‰å¤©æ»šåŠ¨ï¼‰ --&gt;
    &lt;appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;file&gt;logs/application.log&lt;/file&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
            &lt;fileNamePattern&gt;logs/application.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- æ—¥å¿—çº§åˆ«é…ç½® --&gt;
    &lt;logger name="com.example.langchain4j" level="DEBUG"/&gt;
    &lt;logger name="dev.langchain4j" level="INFO"/&gt;

    &lt;root level="INFO"&gt;
        &lt;appender-ref ref="CONSOLE"/&gt;
        &lt;appender-ref ref="FILE"/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
*/
                    </code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">5.2 æŒ‡æ ‡ç›‘æ§</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">MetricsService.java</div>
                        <div class="text-xs text-gray-400">æŒ‡æ ‡æ”¶é›†æœåŠ¡</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.langchain4j.service;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.concurrent.TimeUnit;

/**
 * æŒ‡æ ‡æ”¶é›†æœåŠ¡
 * ä½¿ç”¨Micrometeræ”¶é›†åº”ç”¨æŒ‡æ ‡
 */
@Slf4j
@Service
public class MetricsService {

    private final MeterRegistry meterRegistry;

    // APIè°ƒç”¨è®¡æ•°å™¨
    private final Counter apiCallCounter;
    private final Counter apiErrorCounter;

    // APIè°ƒç”¨è€—æ—¶è®¡æ—¶å™¨
    private final Timer apiCallTimer;

    // Tokenä½¿ç”¨è®¡æ•°å™¨
    private final Counter tokenInputCounter;
    private final Counter tokenOutputCounter;

    // ç¼“å­˜å‘½ä¸­è®¡æ•°å™¨
    private final Counter cacheHitCounter;
    private final Counter cacheMissCounter;

    public MetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        // åˆå§‹åŒ–è®¡æ•°å™¨
        this.apiCallCounter = Counter.builder("api.call.total")
            .description("APIè°ƒç”¨æ€»æ•°")
            .tag("type", "openai")
            .register(meterRegistry);

        this.apiErrorCounter = Counter.builder("api.call.error")
            .description("APIè°ƒç”¨é”™è¯¯æ•°")
            .tag("type", "openai")
            .register(meterRegistry);

        // åˆå§‹åŒ–è®¡æ—¶å™¨
        this.apiCallTimer = Timer.builder("api.call.duration")
            .description("APIè°ƒç”¨è€—æ—¶")
            .tag("type", "openai")
            .register(meterRegistry);

        // åˆå§‹åŒ–Tokenè®¡æ•°å™¨
        this.tokenInputCounter = Counter.builder("api.token.input")
            .description("è¾“å…¥Tokenæ•°")
            .tag("type", "openai")
            .register(meterRegistry);

        this.tokenOutputCounter = Counter.builder("api.token.output")
            .description("è¾“å‡ºTokenæ•°")
            .tag("type", "openai")
            .register(meterRegistry);

        // åˆå§‹åŒ–ç¼“å­˜è®¡æ•°å™¨
        this.cacheHitCounter = Counter.builder("cache.hit")
            .description("ç¼“å­˜å‘½ä¸­æ•°")
            .register(meterRegistry);

        this.cacheMissCounter = Counter.builder("cache.miss")
            .description("ç¼“å­˜æœªå‘½ä¸­æ•°")
            .register(meterRegistry);
    }

    /**
     * è®°å½•APIè°ƒç”¨å¼€å§‹
     */
    public Timer.Sample startApiCall(String model) {
        apiCallCounter.increment();
        return Timer.start(meterRegistry);
    }

    /**
     * è®°å½•APIè°ƒç”¨å®Œæˆ
     */
    public void endApiCall(Timer.Sample sample, String model, boolean success) {
        sample.stop(Timer.builder("api.call.duration")
            .tag("model", model)
            .tag("success", String.valueOf(success))
            .register(meterRegistry));

        if (!success) {
            apiErrorCounter.increment();
        }
    }

    /**
     * è®°å½•Tokenä½¿ç”¨
     */
    public void recordTokenUsage(int inputTokens, int outputTokens) {
        tokenInputCounter.increment(inputTokens);
        tokenOutputCounter.increment(outputTokens);
    }

    /**
     * è®°å½•ç¼“å­˜å‘½ä¸­
     */
    public void recordCacheHit(String cacheName) {
        cacheHitCounter.increment(Tags.of("cache", cacheName));
    }

    /**
     * è®°å½•ç¼“å­˜æœªå‘½ä¸­
     */
    public void recordCacheMiss(String cacheName) {
        cacheMissCounter.increment(Tags.of("cache", cacheName));
    }

    /**
     * è·å–ç¼“å­˜å‘½ä¸­ç‡
     */
    public double getCacheHitRate(String cacheName) {
        double hits = cacheHitCounter.count();
        double misses = cacheMissCounter.count();
        if (hits + misses == 0) {
            return 0.0;
        }
        return hits / (hits + misses);
    }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
@Service
public class MonitoredAiService {

    private final AiAgent aiAgent;
    private final MetricsService metricsService;

    public String generate(String prompt) {
        Timer.Sample sample = metricsService.startApiCall("gpt-4");

        try {
            String response = aiAgent.generate(prompt);
            metricsService.endApiCall(sample, "gpt-4", true);
            return response;
        } catch (Exception e) {
            metricsService.endApiCall(sample, "gpt-4", false);
            throw e;
        }
    }

    public String generateWithCache(String prompt) {
        String cacheKey = "prompt:" + prompt.hashCode();

        // å°è¯•ä»ç¼“å­˜è·å–
        String cached = getFromCache(cacheKey);
        if (cached != null) {
            metricsService.recordCacheHit("embedding");
            return cached;
        }

        // ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨AI
        metricsService.recordCacheMiss("embedding");
        String response = aiAgent.generate(prompt);

        // å­˜å…¥ç¼“å­˜
        putToCache(cacheKey, response);

        return response;
    }
}
                    </code></pre>
                </div>

                <div class="bg-purple-50 border border-purple-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-purple-600">ğŸ“Š</span> å…³é”®ç›‘æ§æŒ‡æ ‡
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>APIè°ƒç”¨æˆåŠŸç‡</strong>ï¼šç›‘æ§APIè°ƒç”¨çš„æˆåŠŸ/å¤±è´¥æ¯”ä¾‹</li>
                        <li>â€¢ <strong>å“åº”å»¶è¿Ÿ</strong>ï¼šP50ã€P95ã€P99å»¶è¿Ÿç™¾åˆ†ä½</li>
                        <li>â€¢ <strong>Tokenä½¿ç”¨é‡</strong>ï¼šè¾“å…¥/è¾“å‡ºTokenè®¡æ•°å’Œæˆæœ¬</li>
                        <li>â€¢ <strong>ç¼“å­˜å‘½ä¸­ç‡</strong>ï¼šEmbeddingã€RAGæ£€ç´¢ç­‰ç¼“å­˜æ•ˆæœ</li>
                        <li>â€¢ <strong>é”™è¯¯ç‡</strong>ï¼šæŒ‰é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡</li>
                        <li>â€¢ <strong>å¹¶å‘æ•°</strong>ï¼šåŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°</li>
                    </ul>
                </div>
            </section>

            <section class="mb-16">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg p-8 text-white">
                    <h2 class="text-2xl font-bold mb-4">ğŸ¯ æœ€ä½³å®è·µæ€»ç»“</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ—ï¸ æ¶æ„è®¾è®¡</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ åˆ†å±‚æ¶æ„æ¨¡å¼</li>
                                <li>â€¢ é¢å‘æ¥å£ç¼–ç¨‹</li>
                                <li>â€¢ é…ç½®é›†ä¸­ç®¡ç†</li>
                                <li>â€¢ å¼‚å¸¸ç»Ÿä¸€å¤„ç†</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">âš¡ æ€§èƒ½ä¼˜åŒ–</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ HTTPè¿æ¥æ± </li>
                                <li>â€¢ æ‰¹é‡å¤„ç†</li>
                                <li>â€¢ å¤šçº§ç¼“å­˜</li>
                                <li>â€¢ å¼‚æ­¥å¤„ç†</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ›¡ï¸ å®‰å…¨å®è·µ</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ å¯†é’¥ç®¡ç†</li>
                                <li>â€¢ è¾“å…¥éªŒè¯</li>
                                <li>â€¢ å†…å®¹è¿‡æ»¤</li>
                                <li>â€¢ è®¿é—®æ§åˆ¶</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ”§ é”™è¯¯å¤„ç†</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ å¼‚å¸¸åˆ†ç±»</li>
                                <li>â€¢ é‡è¯•æœºåˆ¶</li>
                                <li>â€¢ ç†”æ–­é™çº§</li>
                                <li>â€¢ è¶…æ—¶æ§åˆ¶</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ“ æ—¥å¿—è§„èŒƒ</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ ç»“æ„åŒ–æ—¥å¿—</li>
                                <li>â€¢ æ€§èƒ½æ—¥å¿—</li>
                                <li>â€¢ é”™è¯¯æ—¥å¿—</li>
                                <li>â€¢ æ—¥å¿—è„±æ•</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ“Š ç›‘æ§æŒ‡æ ‡</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ APIæˆåŠŸç‡</li>
                                <li>â€¢ å“åº”å»¶è¿Ÿ</li>
                                <li>â€¢ Tokenä½¿ç”¨</li>
                                <li>â€¢ ç¼“å­˜å‘½ä¸­ç‡</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-lg mb-2">ğŸ“š <strong>ä¸‹ä¸€ç« ï¼šexamples.html</strong></p>
                        <p class="text-sm">æŸ¥çœ‹æ›´å¤šå®æˆ˜ç¤ºä¾‹ï¼ŒåŒ…æ‹¬å¸¸è§åœºæ™¯çš„å®Œæ•´ä»£ç å®ç°</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
</body>
</html>
