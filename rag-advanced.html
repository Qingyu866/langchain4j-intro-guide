<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG é«˜çº§æŠ€æœ¯ - LangChain4j å®Œæ•´æŒ‡å—</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="header-container">
            <h1>RAG é«˜çº§æŠ€æœ¯</h1>
            <p class="subtitle">æ·±å…¥æŒæ¡æ··åˆæ£€ç´¢ã€é‡æ’åºã€æ€§èƒ½ä¼˜åŒ–å’Œç”Ÿäº§éƒ¨ç½²</p>
        </div>
    </header>

    <nav class="top-nav">
        <ul>
            <li><a href="index.html">é¦–é¡µ</a></li>
            <li><a href="quickstart.html">å¿«é€Ÿå¼€å§‹</a></li>
            <li><a href="core-concepts.html">æ ¸å¿ƒæ¦‚å¿µ</a></li>
            <li><a href="rag-intro.html">RAG å®Œæ•´æŒ‡å—</a></li>
            <li><a href="interview-prep.html">é¢è¯•å‡†å¤‡</a></li>
        </ul>
    </nav>

    <main class="content-container">
        <section class="learning-objectives">
            <h2>ğŸ“š å­¦ä¹ ç›®æ ‡</h2>
            <ul>
                <li>ç†è§£æ··åˆæ£€ç´¢çš„åŸç†å’Œå®ç°</li>
                <li>æŒæ¡é‡æ’åºç®—æ³•æå‡æ£€ç´¢è´¨é‡</li>
                <li>å­¦ä¹ å¤šæŸ¥è¯¢ç­–ç•¥æå‡æ£€ç´¢è¦†ç›–ç‡</li>
                <li>ä¼˜åŒ– RAG ç³»ç»Ÿæ€§èƒ½ï¼ˆå»¶è¿Ÿã€ååé‡ã€å‡†ç¡®ç‡ï¼‰</li>
                <li>éƒ¨ç½² RAG ç³»ç»Ÿåˆ°ç”Ÿäº§ç¯å¢ƒ</li>
                <li>å»ºç«‹ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ</li>
            </ul>
        </section>

        <h1>RAG é«˜çº§æŠ€æœ¯</h1>

        <h2 id="1-æ··åˆæ£€ç´¢">1. æ··åˆæ£€ç´¢ï¼ˆHybrid Retrievalï¼‰</h2>

        <h3 id="11-ä»€ä¹ˆæ˜¯æ··åˆæ£€ç´¢">1.1 ä»€ä¹ˆæ˜¯æ··åˆæ£€ç´¢ï¼Ÿ</h3>

        <p>æ··åˆæ£€ç´¢ç»“åˆäº†<strong>å‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰æ£€ç´¢ï¼‰</strong>å’Œ<strong>å…³é”®è¯æ£€ç´¢ï¼ˆBM25ï¼‰</strong>çš„ä¼˜åŠ¿ï¼Œèƒ½å¤ŸåŒæ—¶åˆ©ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦å’Œç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼Œæ˜¾è‘—æå‡æ£€ç´¢è´¨é‡ã€‚</p>

        <h4>æ ¸å¿ƒä¼˜åŠ¿ï¼š</h4>
        <ul>
            <li><strong>è¯­ä¹‰ç†è§£</strong>ï¼šå‘é‡æ£€ç´¢èƒ½å¤Ÿç†è§£åŒä¹‰è¯ã€è¯­ä¹‰ç›¸è¿‘çš„æŸ¥è¯¢</li>
            <li><strong>ç²¾ç¡®åŒ¹é…</strong>ï¼šå…³é”®è¯æ£€ç´¢èƒ½å¤ŸåŒ¹é…ç²¾ç¡®æœ¯è¯­ã€ä¸“æœ‰åè¯</li>
            <li><strong>äº’è¡¥æ€§å¼º</strong>ï¼šä¸¤ç§æ£€ç´¢æ–¹å¼äº’è¡¥ï¼Œè¦†ç›–æ›´å¤šç›¸å…³æ–‡æ¡£</li>
            <li><strong>æå‡å‡†ç¡®ç‡</strong>ï¼šæ··åˆæ£€ç´¢é€šå¸¸æ¯”å•ä¸€æ£€ç´¢æ–¹æ³•å‡†ç¡®ç‡æå‡ 10-30%</li>
        </ul>

        <h4>é€‚ç”¨åœºæ™¯ï¼š</h4>
        <ul>
            <li>ä¸“ä¸šé¢†åŸŸï¼ˆåŒ»å­¦ã€æ³•å¾‹ã€é‡‘èï¼‰ï¼ŒåŒ…å«å¤§é‡ä¸“ä¸šæœ¯è¯­</li>
            <li>å¤šè¯­è¨€æ£€ç´¢åœºæ™¯</li>
            <li>éœ€è¦ç²¾ç¡®åŒ¹é…ç‰¹å®šå…³é”®è¯æˆ–ç¼–å·çš„æŸ¥è¯¢</li>
            <li>æŸ¥è¯¢ä¸­åŒ…å«åŒä¹‰è¯ã€ç¼©å†™çš„åœºæ™¯</li>
        </ul>

        <h3 id="12-æ··åˆæ£€ç´¢æ¶æ„">1.2 æ··åˆæ£€ç´¢æ¶æ„</h3>

        <pre><code class="mermaid">graph TB
    A[ç”¨æˆ·æŸ¥è¯¢] --> B[å‘é‡æ£€ç´¢]
    A --> C[å…³é”®è¯æ£€ç´¢ BM25]
    B --> D[æ£€ç´¢ç»“æœ 1]
    C --> E[æ£€ç´¢ç»“æœ 2]
    D --> F[ç»“æœèåˆ RRF]
    E --> F
    F --> G[é‡æ’åº Reranker]
    G --> H[æœ€ç»ˆç»“æœ]</code></pre>

        <h4>æ£€ç´¢æµç¨‹ï¼š</h4>
        <ol>
            <li><strong>å¹¶è¡Œæ£€ç´¢</strong>ï¼šåŒæ—¶è¿›è¡Œå‘é‡æ£€ç´¢å’Œå…³é”®è¯æ£€ç´¢</li>
            <li><strong>ç»“æœèåˆ</strong>ï¼šä½¿ç”¨èåˆç®—æ³•ï¼ˆå¦‚ RRFï¼‰åˆå¹¶ä¸¤ç§æ£€ç´¢ç»“æœ</li>
            <li><strong>é‡æ’åº</strong>ï¼šä½¿ç”¨é‡æ’åºæ¨¡å‹å¯¹èåˆåçš„ç»“æœé‡æ–°æ‰“åˆ†æ’åº</li>
            <li><strong>è¿”å› Top-K</strong>ï¼šè¿”å›æœ€ç›¸å…³çš„ K ä¸ªæ–‡æ¡£</li>
        </ol>

        <h3 id="13-å‘é‡æ£€ç´¢-vs-å…³é”®è¯æ£€ç´¢">1.3 å‘é‡æ£€ç´¢ vs å…³é”®è¯æ£€ç´¢</h3>

        <table>
            <thead>
                <tr>
                    <th>ç»´åº¦</th>
                    <th>å‘é‡æ£€ç´¢</th>
                    <th>å…³é”®è¯æ£€ç´¢ï¼ˆBM25ï¼‰</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>æ£€ç´¢åŸç†</strong></td>
                    <td>è¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰</td>
                    <td>è¯é¢‘-é€†æ–‡æ¡£é¢‘ç‡ï¼ˆTF-IDFï¼‰</td>
                </tr>
                <tr>
                    <td><strong>ä¼˜åŠ¿</strong></td>
                    <td>ç†è§£è¯­ä¹‰ã€åŒä¹‰è¯ã€æ¦‚å¿µ</td>
                    <td>ç²¾ç¡®åŒ¹é…ã€å¤„ç†ä¸“ä¸šæœ¯è¯­</td>
                </tr>
                <tr>
                    <td><strong>åŠ£åŠ¿</strong></td>
                    <td>éš¾ä»¥å¤„ç†ç²¾ç¡®åŒ¹é…ã€å¤šä¹‰è¯</td>
                    <td>æ— æ³•ç†è§£è¯­ä¹‰ã€åŒä¹‰è¯</td>
                </tr>
                <tr>
                    <td><strong>ç´¢å¼•å¤§å°</strong></td>
                    <td>è¾ƒå¤§ï¼ˆå­˜å‚¨å‘é‡ï¼‰</td>
                    <td>è¾ƒå°ï¼ˆä»…å­˜å‚¨å€’æ’ç´¢å¼•ï¼‰</td>
                </tr>
                <tr>
                    <td><strong>æ£€ç´¢é€Ÿåº¦</strong></td>
                    <td>è¾ƒæ…¢ï¼ˆè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼‰</td>
                    <td>è¾ƒå¿«ï¼ˆå€’æ’ç´¢å¼•ï¼‰</td>
                </tr>
                <tr>
                    <td><strong>é€‚åˆåœºæ™¯</strong></td>
                    <td>å¼€æ”¾åŸŸé—®ç­”ã€æ¨èç³»ç»Ÿ</td>
                    <td>ç²¾ç¡®æœç´¢ã€ä»£ç æœç´¢</td>
                </tr>
            </tbody>
        </table>

        <h3 id="14-ç»“æœèåˆç®—æ³•">1.4 ç»“æœèåˆç®—æ³•</h3>

        <h4>Reciprocal Rank Fusion (RRF)</h4>

        <p>RRF æ˜¯æœ€å¸¸ç”¨çš„ç»“æœèåˆç®—æ³•ï¼Œèƒ½å¤Ÿå¹³è¡¡ä¸¤ç§æ£€ç´¢ç»“æœçš„æ’åã€‚</p>

        <p><strong>å…¬å¼ï¼š</strong></p>
        <pre><code>RRF_score(d) = Î£ [1 / (k + rank_i(d))]</code></pre>

        <ul>
            <li><code>d</code>ï¼šæ–‡æ¡£</li>
            <li><code>rank_i(d)</code>ï¼šæ–‡æ¡£åœ¨ç¬¬ i ä¸ªæ£€ç´¢ç»“æœä¸­çš„æ’å</li>
            <li><code>k</code>ï¼šå¹³æ»‘å¸¸æ•°ï¼ˆé€šå¸¸è®¾ç½®ä¸º 60ï¼‰</li>
        </ul>

        <h4>åŠ æƒèåˆï¼ˆWeighted Fusionï¼‰</h4>

        <p>ç»™ä¸åŒæ£€ç´¢ç»“æœåˆ†é…ä¸åŒæƒé‡ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ã€‚</p>

        <pre><code>fused_score(d) = Î± Ã— vector_score(d) + (1-Î±) Ã— bm25_score(d)</code></pre>

        <ul>
            <li><code>Î±</code>ï¼šæƒé‡å‚æ•°ï¼ˆ0 åˆ° 1ï¼‰
                <ul>
                    <li><code>Î± = 0.3</code>ï¼šæ›´ä¾èµ–å…³é”®è¯æ£€ç´¢ï¼ˆä¸“ä¸šé¢†åŸŸï¼‰</li>
                    <li><code>Î± = 0.7</code>ï¼šæ›´ä¾èµ–å‘é‡æ£€ç´¢ï¼ˆå¼€æ”¾åŸŸï¼‰</li>
                </ul>
            </li>
        </ul>

        <h3 id="15-æ··åˆæ£€ç´¢å®ç°">1.5 æ··åˆæ£€ç´¢å®ç°</h3>

        <h4>å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š</h4>

        <pre><code class="language-java">import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.DocumentSplitter;
import dev.langchain4j.data.document.splitter.DocumentSplitters;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.model.openai.OpenAiEmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import dev.langchain4j.store.embedding.EmbeddingStoreIngestor;
import dev.langchain4j.store.embedding.inmemory.InMemoryEmbeddingStore;
import dev.langchain4j.store.embedding.pinecone.PineconeEmbeddingStore;
import dev.langchain4j.rag.retriever.EmbeddingStoreRetriever;
import dev.langchain4j.rag.content.retriever.ContentRetriever;
import dev.langchain4j.rag.content.aggregator.ContentAggregator;
import dev.langchain4j.rag.content.aggregator.ReRankingContentAggregator;
import dev.langchain4j.rag.query.transformer.QueryTransformer;
import dev.langchain4j.rag.query.transformer.ExpandingQueryTransformer;

import java.util.List;
import java.util.ArrayList;
import java.util.stream.Collectors;

/**
 * æ··åˆæ£€ç´¢ç³»ç»Ÿ
 * ç»“åˆå‘é‡æ£€ç´¢å’Œå…³é”®è¯æ£€ç´¢çš„ä¼˜åŠ¿
 */
public class HybridRetrievalSystem {

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    private final KeywordRetriever keywordRetriever;
    private final ReRanker reRanker;

    public HybridRetrievalSystem() {
        this.embeddingModel = OpenAiEmbeddingModel.builder()
                .apiKey(System.getenv("OPENAI_API_KEY"))
                .modelName("text-embedding-3-small")
                .build();

        this.vectorStore = PineconeEmbeddingStore.builder()
                .apiKey(System.getenv("PINECONE_API_KEY"))
                .index("rag-hybrid-index")
                .build();

        this.keywordRetriever = new BM25Retriever();
        this.reRanker = new CrossEncoderReRanker();
    }

    public List<RetrievalResult> hybridSearch(String query, int topK) {
        // å¹¶è¡Œæ‰§è¡Œä¸¤ç§æ£€ç´¢
        CompletableFuture<List<RetrievalResult>> vectorFuture =
                CompletableFuture.supplyAsync(() -> vectorSearch(query, topK * 2));

        CompletableFuture<List<RetrievalResult>> keywordFuture =
                CompletableFuture.supplyAsync(() -> keywordSearch(query, topK * 2));

        List<RetrievalResult> vectorResults = vectorFuture.join();
        List<RetrievalResult> keywordResults = keywordFuture.join();

        List<RetrievalResult> fusedResults = fuseResults(
                vectorResults,
                keywordResults,
                FusionMethod.RRF,
                60
        );

        List<RetrievalResult> rerankedResults = reRanker.rerank(
                query,
                fusedResults,
                topK
        );

        return rerankedResults;
    }

    public enum FusionMethod {
        RRF, WEIGHTED, COMBINATION
    }

    public enum RetrievalType {
        VECTOR, KEYWORD
    }

    public static class RetrievalResult {
        private final String content;
        private final double score;
        private final RetrievalType type;

        public RetrievalResult(String content, double score, RetrievalType type) {
            this.content = content;
            this.score = score;
            this.type = type;
        }

        public String content() { return content; }
        public double score() { return score; }
        public RetrievalType type() { return type; }
    }
}</code></pre>

        <h2 id="2-é‡æ’åº-reranking">2. é‡æ’åºï¼ˆRerankingï¼‰</h2>

        <h3 id="21-ä»€ä¹ˆæ˜¯é‡æ’åº">2.1 ä»€ä¹ˆæ˜¯é‡æ’åºï¼Ÿ</h3>

        <p>é‡æ’åºæ˜¯åœ¨ç²—ç²’åº¦æ£€ç´¢ï¼ˆå‘é‡æ£€ç´¢/æ··åˆæ£€ç´¢ï¼‰ä¹‹åï¼Œä½¿ç”¨æ›´ç²¾ç»†çš„æ¨¡å‹å¯¹æ£€ç´¢ç»“æœé‡æ–°æ‰“åˆ†æ’åºçš„è¿‡ç¨‹ã€‚é‡æ’åºèƒ½å¤Ÿæ˜¾è‘—æå‡æ£€ç´¢è´¨é‡ï¼Œé€šå¸¸èƒ½å°† Top-10 çš„å‡†ç¡®ç‡æå‡ 5-15%ã€‚</p>

        <h4>é‡æ’åºçš„ä½œç”¨ï¼š</h4>
        <ul>
            <li><strong>æå‡ç²¾åº¦</strong>ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å‹é‡æ–°è¯„ä¼°ç›¸å…³æ€§</li>
            <li><strong>ä¼˜åŒ–æ’åº</strong>ï¼šçº æ­£ç²—ç²’åº¦æ£€ç´¢çš„æ’åºåå·®</li>
            <li><strong>è¿‡æ»¤å™ªå£°</strong>ï¼šå»é™¤ç›¸å…³æ€§ä½çš„æ–‡æ¡£</li>
            <li><strong>æå‡ç”¨æˆ·ä½“éªŒ</strong>ï¼šè¿”å›æ›´ç›¸å…³çš„ç»“æœ</li>
        </ul>

        <h3 id="22-é‡æ’åºæ¨¡å‹">2.2 é‡æ’åºæ¨¡å‹</h3>

        <h4>Cross-Encoderï¼ˆäº¤å‰ç¼–ç å™¨ï¼‰</h4>

        <p>Cross-Encoder å°†æŸ¥è¯¢å’Œæ–‡æ¡£ä¸€èµ·è¾“å…¥æ¨¡å‹ï¼Œç›´æ¥è®¡ç®—ç›¸å…³æ€§åˆ†æ•°ã€‚ç›¸æ¯” Bi-Encoderï¼ˆåŒç¼–ç å™¨ï¼‰ï¼ŒCross-Encoder çš„å‡†ç¡®ç‡æ›´é«˜ï¼Œä½†è®¡ç®—æˆæœ¬ä¹Ÿæ›´é«˜ã€‚</p>

        <p><strong>æ¨¡å‹ç¤ºä¾‹ï¼š</strong></p>
        <ul>
            <li><code>ms-marco-MiniLM-L-6-v2</code> - å¿«é€Ÿã€å‡†ç¡®ç‡é«˜</li>
            <li><code>ms-marco-MiniLM-L-12-v2</code> - æ›´é«˜å‡†ç¡®ç‡</li>
            <li><code>bert-base-uncased-msmarco</code> - å‡†ç¡®ç‡é«˜ï¼Œé€Ÿåº¦ä¸­ç­‰</li>
        </ul>

        <h4>Bi-Encoder vs Cross-Encoder</h4>

        <table>
            <thead>
                <tr>
                    <th>ç»´åº¦</th>
                    <th>Bi-Encoder</th>
                    <th>Cross-Encoder</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>è¾“å…¥æ–¹å¼</strong></td>
                    <td>æŸ¥è¯¢å’Œæ–‡æ¡£åˆ†åˆ«ç¼–ç </td>
                    <td>æŸ¥è¯¢å’Œæ–‡æ¡£ä¸€èµ·ç¼–ç </td>
                </tr>
                <tr>
                    <td><strong>è®¡ç®—æ–¹å¼</strong></td>
                    <td>é¢„è®¡ç®—å‘é‡ï¼Œä½™å¼¦ç›¸ä¼¼åº¦</td>
                    <td>æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—</td>
                </tr>
                <tr>
                    <td><strong>æ£€ç´¢é€Ÿåº¦</strong></td>
                    <td>å¿«ï¼ˆå‘é‡æ£€ç´¢ï¼‰</td>
                    <td>æ…¢ï¼ˆé€ä¸ªè®¡ç®—ï¼‰</td>
                </tr>
                <tr>
                    <td><strong>å‡†ç¡®ç‡</strong></td>
                    <td>ä¸­ç­‰</td>
                    <td>é«˜</td>
                </tr>
                <tr>
                    <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                    <td>ç²—ç²’åº¦æ£€ç´¢</td>
                    <td>ç»†ç²’åº¦é‡æ’åº</td>
                </tr>
                <tr>
                    <td><strong>è®¡ç®—æˆæœ¬</strong></td>
                    <td>ä½</td>
                    <td>é«˜</td>
                </tr>
            </tbody>
        </table>

        <h3 id="23-é‡æ’åºç­–ç•¥">2.3 é‡æ’åºç­–ç•¥</h3>

        <h4>ä¸¤é˜¶æ®µæ£€ç´¢ï¼ˆTwo-Stage Retrievalï¼‰</h4>

        <p>å…ˆç”¨ Bi-Encoder è¿›è¡Œç²—ç²’åº¦æ£€ç´¢ï¼Œå†ç”¨ Cross-Encoder è¿›è¡Œç»†ç²’åº¦é‡æ’åºã€‚è¿™æ˜¯æœ€å¸¸ç”¨çš„ç­–ç•¥ã€‚</p>

        <pre><code class="language-java">/**
 * ä¸¤é˜¶æ®µæ£€ç´¢ç­–ç•¥
 */
public class TwoStageRetrieval {

    private final BiEncoderRetriever biEncoderRetriever;
    private final CrossEncoderReranker crossEncoderReranker;

    public TwoStageRetrieval() {
        this.biEncoderRetriever = new BiEncoderRetriever();
        this.crossEncoderReranker = new CrossEncoderReranker();
    }

    public List<Document> retrieve(String query, int topK) {
        List<Document> candidates = biEncoderRetriever.retrieve(query, topK * 3);
        List<Document> reranked = crossEncoderReranker.rerank(query, candidates, topK);
        return reranked;
    }
}</code></pre>

        <h4>çº§è”é‡æ’åºï¼ˆCascaded Rerankingï¼‰</h4>

        <p>ä½¿ç”¨å¤šä¸ªé‡æ’åºæ¨¡å‹è¿›è¡Œçº§è”é‡æ’åºï¼Œé€æ­¥æå‡ç²¾åº¦ã€‚ä¾‹å¦‚ï¼šå¿«é€Ÿæ¨¡å‹ â†’ ä¸­ç­‰æ¨¡å‹ â†’ é«˜ç²¾åº¦æ¨¡å‹ã€‚</p>

        <pre><code class="language-java">/**
 * çº§è”é‡æ’åºç­–ç•¥
 */
public class CascadedReranking {

    private final List<ReRanker> rerankers;

    public CascadedReranking() {
        this.rerankers = Arrays.asList(
                new FastReranker(),
                new MediumReranker(),
                new HighPrecisionReranker()
        );
    }

    public List<Document> rerank(String query, List<Document> candidates, int topK) {
        List<Document> results = candidates;

        for (int i = 0; i < rerankers.size(); i++) {
            ReRanker reranker = rerankers.get(i);
            int stageTopK = (int) (topK * Math.pow(2, rerankers.size() - i));
            stageTopK = Math.min(stageTopK, results.size());
            results = reranker.rerank(query, results, stageTopK);
        }

        return results.stream()
                .limit(topK)
                .collect(Collectors.toList());
    }
}</code></pre>

        <h4>è‡ªé€‚åº”é‡æ’åºï¼ˆAdaptive Rerankingï¼‰</h4>

        <p>æ ¹æ®æŸ¥è¯¢ç‰¹å¾ã€æ£€ç´¢ç»“æœè´¨é‡è‡ªé€‚åº”å†³å®šæ˜¯å¦è¿›è¡Œé‡æ’åºã€‚ä¾‹å¦‚ï¼šç®€å•æŸ¥è¯¢ä¸é‡æ’åºï¼Œå¤æ‚æŸ¥è¯¢æ‰é‡æ’åºã€‚</p>

        <h2 id="3-å¤šæŸ¥è¯¢ç­–ç•¥">3. å¤šæŸ¥è¯¢ç­–ç•¥</h2>

        <h3 id="31-ä»€ä¹ˆæ˜¯å¤šæŸ¥è¯¢ç­–ç•¥">3.1 ä»€ä¹ˆæ˜¯å¤šæŸ¥è¯¢ç­–ç•¥ï¼Ÿ</h3>

        <p>å¤šæŸ¥è¯¢ç­–ç•¥æ˜¯é€šè¿‡ç”Ÿæˆå¤šä¸ªæŸ¥è¯¢å˜ä½“ï¼Œæ‰©å¤§æ£€ç´¢è¦†ç›–é¢ï¼Œæå‡å¬å›ç‡çš„æŠ€æœ¯ã€‚é€‚ç”¨äºå¤æ‚æŸ¥è¯¢ã€å¤šä¹‰è¯æŸ¥è¯¢ã€éœ€è¦å¤šä¸ªè§’åº¦æ£€ç´¢çš„åœºæ™¯ã€‚</p>

        <h4>å¤šæŸ¥è¯¢ç­–ç•¥çš„ä½œç”¨ï¼š</h4>
        <ul>
            <li><strong>æå‡å¬å›ç‡</strong>ï¼šé€šè¿‡å¤šä¸ªæŸ¥è¯¢è¦†ç›–æ›´å¤šç›¸å…³æ–‡æ¡£</li>
            <li><strong>è§£å†³å¤šä¹‰è¯</strong>ï¼šå¤„ç†ä¸€è¯å¤šä¹‰ã€åŒä¹‰è¯é—®é¢˜</li>
            <li><strong>å¤šè§’åº¦æ£€ç´¢</strong>ï¼šä»ä¸åŒè§’åº¦æ£€ç´¢ç›¸å…³å†…å®¹</li>
            <li><strong>æå‡å‡†ç¡®ç‡</strong>ï¼šç»“åˆå¤šä¸ªæ£€ç´¢ç»“æœï¼Œæå‡æœ€ç»ˆå‡†ç¡®ç‡</li>
        </ul>

        <h3 id="32-æŸ¥è¯¢æ‰©å±•ç­–ç•¥">3.2 æŸ¥è¯¢æ‰©å±•ç­–ç•¥</h3>

        <h4>æŸ¥è¯¢é‡å†™ï¼ˆQuery Rewritingï¼‰</h4>

        <p>ä½¿ç”¨ LLM é‡å†™æŸ¥è¯¢ï¼Œç”Ÿæˆæ›´å‡†ç¡®ã€æ›´ä¸°å¯Œçš„æŸ¥è¯¢å˜ä½“ã€‚</p>

        <pre><code class="language-java">/**
 * æŸ¥è¯¢é‡å†™ç­–ç•¥
 */
public class QueryRewriting {

    private final ChatLanguageModel llm;

    public QueryRewriting() {
        this.llm = OpenAiChatModel.builder()
                .apiKey(System.getenv("OPENAI_API_KEY"))
                .modelName("gpt-4o-mini")
                .build();
    }

    public List<String> expandQuery(String originalQuery, int variants) {
        String prompt = String.format(
                "ä½ æ˜¯æŸ¥è¯¢é‡å†™ä¸“å®¶ã€‚è¯·ä¸ºä»¥ä¸‹æŸ¥è¯¢ç”Ÿæˆ %d ä¸ªä¸åŒçš„å˜ä½“ã€‚" +
                "è¦æ±‚ï¼š\n" +
                "1. ä¿æŒåŸæŸ¥è¯¢çš„æ ¸å¿ƒæ„å›¾\n" +
                "2. ä½¿ç”¨ä¸åŒçš„è¡¨è¾¾æ–¹å¼\n" +
                "3. åŒ…å«åŒä¹‰è¯å’Œç›¸å…³æ¦‚å¿µ\n" +
                "4. æ¯ä¸ªå˜ä½“éƒ½è¦èƒ½ç‹¬ç«‹æ£€ç´¢åˆ°ç›¸å…³æ–‡æ¡£\n\n" +
                "åŸæŸ¥è¯¢ï¼š%s\n\n" +
                "ä»…è¿”å›å˜ä½“åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¸è¦åŒ…å«åºå·å’Œé¢å¤–è¯´æ˜ã€‚",
                variants, originalQuery
        );

        String response = llm.generate(prompt);

        return Arrays.stream(response.split("\n"))
                .map(String::trim)
                .filter(line -> !line.isEmpty())
                .collect(Collectors.toList());
    }
}</code></pre>

        <h4>æŸ¥è¯¢åˆ†è§£ï¼ˆQuery Decompositionï¼‰</h4>

        <p>å°†å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªå­æŸ¥è¯¢ï¼Œåˆ†åˆ«æ£€ç´¢ååˆå¹¶ç»“æœã€‚é€‚ç”¨äºå¤åˆæŸ¥è¯¢ã€å¤šä¸»é¢˜æŸ¥è¯¢ã€‚</p>

        <h4>HyDEï¼ˆHypothetical Document Embeddingsï¼‰</h4>

        <p>ä½¿ç”¨ LLM ç”Ÿæˆå‡è®¾æ€§æ–‡æ¡£ï¼Œç„¶åç”¨å‡è®¾æ€§æ–‡æ¡£çš„åµŒå…¥å‘é‡è¿›è¡Œæ£€ç´¢ã€‚é€‚ç”¨äºæŠ½è±¡æŸ¥è¯¢ã€æ¦‚å¿µæ€§æŸ¥è¯¢ã€‚</p>

        <h2 id="4-æ€§èƒ½ä¼˜åŒ–">4. æ€§èƒ½ä¼˜åŒ–</h2>

        <h3 id="41-rag-æ€§èƒ½ç“¶é¢ˆåˆ†æ">4.1 RAG æ€§èƒ½ç“¶é¢ˆåˆ†æ</h3>

        <p>RAG ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆä¸»è¦é›†ä¸­åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>

        <table>
            <thead>
                <tr>
                    <th>é˜¶æ®µ</th>
                    <th>æ½œåœ¨ç“¶é¢ˆ</th>
                    <th>ä¼˜åŒ–ç­–ç•¥</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>æ£€ç´¢</strong></td>
                    <td>å‘é‡æ•°æ®åº“æŸ¥è¯¢æ…¢</td>
                    <td>ä½¿ç”¨è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼ˆHNSWï¼‰ã€ç´¢å¼•ä¼˜åŒ–ã€åˆ†ç‰‡</td>
                </tr>
                <tr>
                    <td><strong>åµŒå…¥ç”Ÿæˆ</strong></td>
                    <td>Embedding æ¨¡å‹æ¨ç†æ…¢</td>
                    <td>æ‰¹é‡æ¨ç†ã€æ¨¡å‹é‡åŒ–ã€ç¼“å­˜åµŒå…¥</td>
                </tr>
                <tr>
                    <td><strong>é‡æ’åº</strong></td>
                    <td>Cross-Encoder æ¨ç†æ…¢</td>
                    <td>GPU åŠ é€Ÿã€æ‰¹é‡æ¨ç†ã€å‡å°‘å€™é€‰æ–‡æ¡£</td>
                </tr>
                <tr>
                    <td><strong>ç”Ÿæˆ</strong></td>
                    <td>LLM æ¨ç†æ…¢</td>
                    <td>æµå¼è¾“å‡ºã€æ¨¡å‹é€‰æ‹©ã€æç¤ºè¯ä¼˜åŒ–</td>
                </tr>
                <tr>
                    <td><strong>ç½‘ç»œ</strong></td>
                    <td>API è°ƒç”¨å»¶è¿Ÿé«˜</td>
                    <td>å¹¶å‘è¯·æ±‚ã€æœ¬åœ°éƒ¨ç½²ã€CDN</td>
                </tr>
            </tbody>
        </table>

        <h3 id="42-æ£€ç´¢æ€§èƒ½ä¼˜åŒ–">4.2 æ£€ç´¢æ€§èƒ½ä¼˜åŒ–</h3>

        <h4>è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼ˆANNï¼‰</h4>

        <p>ä½¿ç”¨è¿‘ä¼¼ç®—æ³•æ›¿ä»£ç²¾ç¡®æœ€è¿‘é‚»æœç´¢ï¼Œå¤§å¹…æå‡æ£€ç´¢é€Ÿåº¦ï¼Œç‰ºç‰²å°‘é‡ç²¾åº¦ã€‚</p>

        <ul>
            <li><strong>HNSWï¼ˆHierarchical Navigable Small Worldï¼‰</strong>ï¼šæœ€å¸¸ç”¨çš„ ANN ç®—æ³•ï¼Œå¹³è¡¡é€Ÿåº¦å’Œç²¾åº¦</li>
            <li><strong>IVFï¼ˆInverted File Indexï¼‰</strong>ï¼šé€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®</li>
            <li><strong>FAISSï¼ˆFacebook AI Similarity Searchï¼‰</strong>ï¼šé«˜æ•ˆå‘é‡æ£€ç´¢åº“</li>
        </ul>

        <h4>ç´¢å¼•åˆ†ç‰‡ï¼ˆShardingï¼‰</h4>

        <p>å°†å‘é‡ç´¢å¼•åˆ†ç‰‡åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œæå‡æ£€ç´¢ååé‡ã€‚é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®ã€é«˜å¹¶å‘åœºæ™¯ã€‚</p>

        <h3 id="43-åµŒå…¥ç”Ÿæˆä¼˜åŒ–">4.3 åµŒå…¥ç”Ÿæˆä¼˜åŒ–</h3>

        <h4>æ‰¹é‡æ¨ç†ï¼ˆBatch Inferenceï¼‰</h4>

        <p>æ‰¹é‡ç”ŸæˆåµŒå…¥å‘é‡ï¼Œå‡å°‘ API è°ƒç”¨æ¬¡æ•°ï¼Œæå‡ååé‡ã€‚</p>

        <h4>ç¼“å­˜åµŒå…¥ï¼ˆCachingï¼‰</h4>

        <p>ç¼“å­˜å·²ç”Ÿæˆçš„åµŒå…¥å‘é‡ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚é€‚ç”¨äºé‡å¤æ–‡æ¡£ã€é¢‘ç¹æŸ¥è¯¢çš„åœºæ™¯ã€‚</p>

        <h3 id="44-ç”Ÿæˆæ€§èƒ½ä¼˜åŒ–">4.4 ç”Ÿæˆæ€§èƒ½ä¼˜åŒ–</h3>

        <h4>æµå¼è¾“å‡ºï¼ˆStreamingï¼‰</h4>

        <p>ä½¿ç”¨æµå¼è¾“å‡ºï¼Œé€æ­¥ç”Ÿæˆç­”æ¡ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚LLM å¼€å§‹ç”Ÿæˆåç«‹å³è¿”å›éƒ¨åˆ†ç»“æœã€‚</p>

        <h4>æ¨¡å‹é€‰æ‹©ï¼ˆModel Selectionï¼‰</h4>

        <p>æ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ¨¡å‹ã€‚ç®€å•ä»»åŠ¡ä½¿ç”¨å°æ¨¡å‹ï¼ˆé€Ÿåº¦å¿«ã€æˆæœ¬ä½ï¼‰ï¼Œå¤æ‚ä»»åŠ¡ä½¿ç”¨å¤§æ¨¡å‹ï¼ˆå‡†ç¡®ç‡é«˜ï¼‰ã€‚</p>

        <table>
            <thead>
                <tr>
                    <th>æ¨¡å‹</th>
                    <th>é€Ÿåº¦</th>
                    <th>æˆæœ¬</th>
                    <th>å‡†ç¡®ç‡</th>
                    <th>é€‚ç”¨åœºæ™¯</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>gpt-4o-mini</code></td>
                    <td>å¿«</td>
                    <td>ä½</td>
                    <td>ä¸­ç­‰</td>
                    <td>ç®€å•é—®ç­”ã€å¿«é€Ÿå“åº”</td>
                </tr>
                <tr>
                    <td><code>gpt-4o</code></td>
                    <td>ä¸­ç­‰</td>
                    <td>ä¸­ç­‰</td>
                    <td>é«˜</td>
                    <td>é€šç”¨ä»»åŠ¡ã€å¹³è¡¡æ€§èƒ½</td>
                </tr>
                <tr>
                    <td><code>gpt-4-turbo</code></td>
                    <td>ä¸­ç­‰</td>
                    <td>é«˜</td>
                    <td>å¾ˆé«˜</td>
                    <td>å¤æ‚æ¨ç†ã€ä¸“ä¸šé¢†åŸŸ</td>
                </tr>
            </tbody>
        </table>

        <h4>æç¤ºè¯ä¼˜åŒ–ï¼ˆPrompt Optimizationï¼‰</h4>

        <p>ä¼˜åŒ–æç¤ºè¯ç»“æ„ï¼Œå‡å°‘ LLM æ¨ç†æ—¶é—´ã€‚ä½¿ç”¨ç®€æ´ã€æ˜ç¡®çš„æŒ‡ä»¤ï¼Œé¿å…å†—ä½™ä¿¡æ¯ã€‚</p>

        <h2 id="5-ç”Ÿäº§éƒ¨ç½²">5. ç”Ÿäº§éƒ¨ç½²</h2>

        <h3 id="51-æ¶æ„è®¾è®¡">5.1 æ¶æ„è®¾è®¡</h3>

        <h4>é«˜å¯ç”¨æ¶æ„</h4>

        <pre><code class="mermaid">graph TB
    A[è´Ÿè½½å‡è¡¡å™¨] --> B[RAG æœåŠ¡ 1]
    A --> C[RAG æœåŠ¡ 2]
    A --> D[RAG æœåŠ¡ 3]
    B --> E[å‘é‡æ•°æ®åº“ ä¸»èŠ‚ç‚¹]
    B --> F[å‘é‡æ•°æ®åº“ ä»èŠ‚ç‚¹]
    C --> E
    C --> F
    D --> E
    D --> F
    E --> G[Redis ç¼“å­˜]
    F --> G
    B --> H[OpenAI API]
    C --> H
    D --> H</code></pre>

        <h4>å…³é”®ç»„ä»¶ï¼š</h4>
        <ul>
            <li><strong>è´Ÿè½½å‡è¡¡å™¨</strong>ï¼šNginx / HAProxyï¼Œåˆ†å‘è¯·æ±‚åˆ°å¤šä¸ª RAG æœåŠ¡</li>
            <li><strong>RAG æœåŠ¡</strong>ï¼šSpring Boot / FastAPIï¼Œå¤„ç†æ£€ç´¢å’Œç”Ÿæˆ</li>
            <li><strong>å‘é‡æ•°æ®åº“</strong>ï¼šPinecone / Weaviateï¼Œä¸»ä»å¤åˆ¶ï¼Œé«˜å¯ç”¨</li>
            <li><strong>ç¼“å­˜å±‚</strong>ï¼šRedisï¼Œç¼“å­˜æŸ¥è¯¢ç»“æœå’ŒåµŒå…¥</li>
            <li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šKafka / RabbitMQï¼Œå¼‚æ­¥ä»»åŠ¡</li>
        </ul>

        <h3 id="52-å®¹å™¨åŒ–éƒ¨ç½²">5.2 å®¹å™¨åŒ–éƒ¨ç½²</h3>

        <h4>Dockerfile ç¤ºä¾‹ï¼š</h4>

        <pre><code class="language-dockerfile"># å¤šé˜¶æ®µæ„å»º Dockerfile

# æ„å»ºé˜¶æ®µ
FROM maven:3.9-eclipse-temurin-21 AS builder

WORKDIR /app
COPY pom.xml .
COPY src ./src

RUN mvn clean package -DskipTests

# è¿è¡Œé˜¶æ®µ
FROM eclipse-temurin:21-jre

WORKDIR /app

COPY --from=builder /app/target/rag-service.jar .

ENV JAVA_OPTS="-Xms2g -Xmx2g -XX:+UseG1GC"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar rag-service.jar"]</code></pre>

        <h4>docker-compose.yml ç¤ºä¾‹ï¼š</h4>

        <pre><code class="language-yaml">version: '3.8'

services:
  rag-service:
    build: .
    ports:
      - "8080:8080"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

volumes:
  redis_data:
  prometheus_data:
  grafana_data:</code></pre>

        <h3 id="53-kubernetes-éƒ¨ç½²">5.3 Kubernetes éƒ¨ç½²</h3>

        <h4>Deployment ç¤ºä¾‹ï¼š</h4>

        <pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: rag-service
  labels:
    app: rag-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rag-service
  template:
    metadata:
      labels:
        app: rag-service
    spec:
      containers:
      - name: rag-service
        image: your-registry/rag-service:latest
        ports:
        - containerPort: 8080
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: api-secrets
              key: openai-api-key
        - name: JAVA_OPTS
          value: "-Xms2g -Xmx2g -XX:+UseG1GC"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5</code></pre>

        <h4>Service ç¤ºä¾‹ï¼š</h4>

        <pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: rag-service
spec:
  selector:
    app: rag-service
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: LoadBalancer</code></pre>

        <h4>HorizontalPodAutoscaler ç¤ºä¾‹ï¼š</h4>

        <pre><code class="language-yaml">apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: rag-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: rag-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80</code></pre>

        <h2 id="6-ç›‘æ§å’Œæ—¥å¿—">6. ç›‘æ§å’Œæ—¥å¿—</h2>

        <h3 id="61-ç›‘æ§æŒ‡æ ‡">6.1 ç›‘æ§æŒ‡æ ‡</h3>

        <h4>å…³é”®æŒ‡æ ‡ï¼š</h4>

        <table>
            <thead>
                <tr>
                    <th>ç±»åˆ«</th>
                    <th>æŒ‡æ ‡</th>
                    <th>ç›®æ ‡å€¼</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>æ€§èƒ½</strong></td>
                    <td>P95 å»¶è¿Ÿ</td>
                    <td>&lt; 2s</td>
                </tr>
                <tr>
                    <td><strong>æ€§èƒ½</strong></td>
                    <td>P99 å»¶è¿Ÿ</td>
                    <td>&lt; 5s</td>
                </tr>
                <tr>
                    <td><strong>æ€§èƒ½</strong></td>
                    <td>ååé‡ï¼ˆQPSï¼‰</td>
                    <td>&gt; 100</td>
                </tr>
                <tr>
                    <td><strong>å¯ç”¨æ€§</strong></td>
                    <td>æˆåŠŸç‡</td>
                    <td>&gt; 99.9%</td>
                </tr>
                <tr>
                    <td><strong>å‡†ç¡®ç‡</strong></td>
                    <td>Top-1 å‡†ç¡®ç‡</td>
                    <td>&gt; 70%</td>
                </tr>
                <tr>
                    <td><strong>å‡†ç¡®ç‡</strong></td>
                    <td>Top-5 å‡†ç¡®ç‡</td>
                    <td>&gt; 85%</td>
                </tr>
            </tbody>
        </table>

        <h3 id="62-prometheus-é…ç½®">6.2 Prometheus é…ç½®</h3>

        <pre><code class="language-yaml"># prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'rag-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['rag-service:8080']

  - job_name: 'vector-db'
    static_configs:
      - targets: ['vector-db:8081']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']</code></pre>

        <h3 id="63-grafana-ä»ªè¡¨ç›˜">6.3 Grafana ä»ªè¡¨ç›˜</h3>

        <h4>æ¨èé¢æ¿ï¼š</h4>
        <ul>
            <li><strong>è¯·æ±‚æŒ‡æ ‡</strong>ï¼šQPSã€æˆåŠŸç‡ã€é”™è¯¯ç‡</li>
            <li><strong>å»¶è¿ŸæŒ‡æ ‡</strong>ï¼šP50ã€P95ã€P99 å»¶è¿Ÿ</li>
            <li><strong>æ£€ç´¢æŒ‡æ ‡</strong>ï¼šæ£€ç´¢æ—¶é—´ã€æ£€ç´¢æ•°é‡ã€æ£€ç´¢å‡†ç¡®ç‡</li>
            <li><strong>ç”ŸæˆæŒ‡æ ‡</strong>ï¼šç”Ÿæˆæ—¶é—´ã€Token æ•°é‡ã€Token æˆæœ¬</li>
            <li><strong>èµ„æºæŒ‡æ ‡</strong>ï¼šCPUã€å†…å­˜ã€ç½‘ç»œã€ç£ç›˜</li>
        </ul>

        <h3 id="64-æ—¥å¿—ç®¡ç†">6.4 æ—¥å¿—ç®¡ç†</h3>

        <h4>ç»“æ„åŒ–æ—¥å¿—ï¼š</h4>

        <pre><code class="language-java">import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

public class RAGLogger {

    private static final Logger logger = LoggerFactory.getLogger(RAGLogger.class);

    public static void logRetrieval(String query, int retrievedCount, long latencyMs) {
        MDC.put("query", query);
        MDC.put("retrieved_count", String.valueOf(retrievedCount));
        MDC.put("latency_ms", String.valueOf(latencyMs));
        MDC.put("event_type", "retrieval");

        logger.info("Retrieved {} documents in {} ms", retrievedCount, latencyMs);

        MDC.clear();
    }

    public static void logGeneration(
            String query,
            int inputTokens,
            int outputTokens,
            long latencyMs
    ) {
        MDC.put("query", query);
        MDC.put("input_tokens", String.valueOf(inputTokens));
        MDC.put("output_tokens", String.valueOf(outputTokens));
        MDC.put("latency_ms", String.valueOf(latencyMs));
        MDC.put("event_type", "generation");

        logger.info("Generated {} output tokens ({} input tokens) in {} ms",
                outputTokens, inputTokens, latencyMs);

        MDC.clear();
    }

    public static void logError(String event, String message, Throwable throwable) {
        MDC.put("event_type", "error");
        MDC.put("event", event);

        logger.error("Error in {}: {}", event, message, throwable);

        MDC.clear();
    }
}</code></pre>

        <h2 id="7-æœ€ä½³å®è·µ">7. æœ€ä½³å®è·µ</h2>

        <h3 id="71-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ">7.1 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</h3>

        <ol>
            <li><strong>ä½¿ç”¨è¿‘ä¼¼æ£€ç´¢</strong>ï¼šHNSW ç´¢å¼•ï¼Œå¹³è¡¡é€Ÿåº¦å’Œç²¾åº¦</li>
            <li><strong>æ‰¹é‡æ¨ç†</strong>ï¼šæ‰¹é‡ç”ŸæˆåµŒå…¥ï¼Œå‡å°‘ API è°ƒç”¨</li>
            <li><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šç¼“å­˜æŸ¥è¯¢ç»“æœå’ŒåµŒå…¥</li>
            <li><strong>æµå¼è¾“å‡º</strong>ï¼šæå‡ç”¨æˆ·ä½“éªŒ</li>
            <li><strong>å¼‚æ­¥ä»»åŠ¡</strong>ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†</li>
            <li><strong>å¹¶å‘è¯·æ±‚</strong>ï¼šå¹¶å‘æ‰§è¡Œå¤šä¸ªæ£€ç´¢</li>
        </ol>

        <h3 id="72-éƒ¨ç½²æœ€ä½³å®è·µ">7.2 éƒ¨ç½²æœ€ä½³å®è·µ</h3>

        <ol>
            <li><strong>å®¹å™¨åŒ–</strong>ï¼šä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²</li>
            <li><strong>ç¼–æ’</strong>ï¼šä½¿ç”¨ Kubernetes ç®¡ç†æœåŠ¡</li>
            <li><strong>é«˜å¯ç”¨</strong>ï¼šå¤šå®ä¾‹éƒ¨ç½²ï¼Œè´Ÿè½½å‡è¡¡</li>
            <li><strong>ç›‘æ§</strong>ï¼šPrometheus + Grafana ç›‘æ§</li>
            <li><strong>æ—¥å¿—</strong>ï¼šç»“æ„åŒ–æ—¥å¿—ï¼ŒELK Stack é›†æˆ</li>
            <li><strong>å¥åº·æ£€æŸ¥</strong>ï¼šé…ç½® liveness å’Œ readiness probe</li>
        </ol>

        <h3 id="73-ç›‘æ§æœ€ä½³å®è·µ">7.3 ç›‘æ§æœ€ä½³å®è·µ</h3>

        <ol>
            <li><strong>å…³é”®æŒ‡æ ‡</strong>ï¼šç›‘æ§å»¶è¿Ÿã€ååé‡ã€å‡†ç¡®ç‡</li>
            <li><strong>å‘Šè­¦è§„åˆ™</strong>ï¼šé…ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼</li>
            <li><strong>ä»ªè¡¨ç›˜</strong>ï¼šå¯è§†åŒ–ç›‘æ§æŒ‡æ ‡</li>
            <li><strong>æ—¥å¿—è¿½è¸ª</strong>ï¼šä½¿ç”¨ Trace ID è¿½è¸ªè¯·æ±‚é“¾è·¯</li>
            <li><strong>å®šæœŸå®¡æŸ¥</strong>ï¼šå®šæœŸå®¡æŸ¥æ€§èƒ½æŒ‡æ ‡</li>
            <li><strong>æŒç»­ä¼˜åŒ–</strong>ï¼šæ ¹æ®ç›‘æ§æ•°æ®æŒç»­ä¼˜åŒ–</li>
        </ol>

        <h2 id="8-å¸¸è§é—®é¢˜faq">8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰</h2>

        <h3>Q1: å¦‚ä½•é€‰æ‹©å‘é‡æ•°æ®åº“ï¼Ÿ</h3>
        <p><strong>A:</strong> æ ¹æ®ä»¥ä¸‹å› ç´ é€‰æ‹©ï¼š</p>
        <ul>
            <li><strong>æ•°æ®è§„æ¨¡</strong>ï¼šå°è§„æ¨¡ï¼ˆ&lt; 1Mï¼‰ç”¨ Chroma/Qdrantï¼Œå¤§è§„æ¨¡ï¼ˆ&gt; 10Mï¼‰ç”¨ Pinecone/Weaviate</li>
            <li><strong>æ€§èƒ½è¦æ±‚</strong>ï¼šé«˜å¹¶å‘ã€ä½å»¶è¿Ÿé€‰æ‹© Pinecloud/Milvus</li>
            <li><strong>æˆæœ¬é¢„ç®—</strong>ï¼šå…è´¹æ–¹æ¡ˆç”¨ Chroma/Qdrantï¼Œä¼ä¸šæ–¹æ¡ˆç”¨ Pinecone/Weaviate</li>
            <li><strong>éƒ¨ç½²æ–¹å¼</strong>ï¼šè‡ªéƒ¨ç½²é€‰ Milvus/Weaviateï¼Œæ‰˜ç®¡æœåŠ¡é€‰ Pinecone</li>
        </ul>

        <h3>Q2: å¦‚ä½•æå‡æ£€ç´¢å‡†ç¡®ç‡ï¼Ÿ</h3>
        <p><strong>A:</strong> å¤šç®¡é½ä¸‹ï¼š</p>
        <ul>
            <li>ä½¿ç”¨æ··åˆæ£€ç´¢ï¼ˆå‘é‡æ£€ç´¢ + å…³é”®è¯æ£€ç´¢ï¼‰</li>
            <li>æ·»åŠ é‡æ’åºå™¨ï¼ˆCross-Encoderï¼‰</li>
            <li>ä¼˜åŒ–æ–‡æœ¬åˆ†å‰²ç­–ç•¥</li>
            <li>å¢åŠ æ£€ç´¢æ•°é‡ï¼ˆtopKï¼‰</li>
            <li>ä½¿ç”¨å¤šæŸ¥è¯¢ç­–ç•¥</li>
        </ul>

        <h3>Q3: å¦‚ä½•é™ä½æˆæœ¬ï¼Ÿ</h3>
        <p><strong>A:</strong> å¤šç§æ–¹å¼ï¼š</p>
        <ul>
            <li>ä½¿ç”¨è¾ƒå°çš„ Embedding æ¨¡å‹ï¼ˆtext-embedding-3-smallï¼‰</li>
            <li>ç¼“å­˜æŸ¥è¯¢ç»“æœå’ŒåµŒå…¥</li>
            <li>ä½¿ç”¨ gpt-4o-mini æ›¿ä»£ gpt-4-turbo</li>
            <li>ä¼˜åŒ–æç¤ºè¯ï¼Œå‡å°‘ Token ä½¿ç”¨</li>
            <li>æ‰¹é‡æ¨ç†ï¼Œå‡å°‘ API è°ƒç”¨</li>
        </ul>

        <h3>Q4: å¦‚ä½•å¤„ç†é•¿æ–‡æ¡£ï¼Ÿ</h3>
        <p><strong>A:</strong> åˆ†å‰²ç­–ç•¥ï¼š</p>
        <ul>
            <li>ä½¿ç”¨é€’å½’æ–‡æœ¬åˆ†å‰²å™¨</li>
            <li>ä¿ç•™è¯­ä¹‰å®Œæ•´æ€§</li>
            <li>æ·»åŠ é‡å ï¼ˆoverlapï¼‰é¿å…ä¿¡æ¯ä¸¢å¤±</li>
            <li>ä½¿ç”¨è¯­ä¹‰åˆ†å‰²ï¼ˆåŸºäºè¯­ä¹‰è¾¹ç•Œï¼‰</li>
            <li>è€ƒè™‘æ–‡æ¡£æ‘˜è¦ + è¯¦ç»†å†…å®¹çš„åˆ†å±‚æ£€ç´¢</li>
        </ul>

        <h3>Q5: å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨ï¼Ÿ</h3>
        <p><strong>A:</strong> å®‰å…¨æªæ–½ï¼š</p>
        <ul>
            <li>ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç† API Key</li>
            <li>å¯ç”¨å‘é‡æ•°æ®åº“çš„è®¿é—®æ§åˆ¶ï¼ˆACLï¼‰</li>
            <li>æ•°æ®åŠ å¯†ï¼ˆé™æ€åŠ å¯† + ä¼ è¾“åŠ å¯†ï¼‰</li>
            <li>å®šæœŸå¤‡ä»½å‘é‡æ•°æ®</li>
            <li>é™åˆ¶ API è°ƒç”¨é¢‘ç‡ï¼ˆRate Limitingï¼‰</li>
        </ul>

        <div class="next-steps">
            <h2>ç»§ç»­å­¦ä¹ </h2>
            <ul>
                <li><a href="index.html">è¿”å›é¦–é¡µ</a></li>
                <li><a href="rag-intro.html">RAG ç®€ä»‹</a></li>
                <li><a href="rag-setup.html">RAG ç¯å¢ƒæ­å»º</a></li>
                <li><a href="rag-implementation.html">RAG å®ç°</a></li>
                <li><a href="interview-prep.html">é¢è¯•å‡†å¤‡</a></li>
            </ul>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 LangChain4j å®Œæ•´æŒ‡å—. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </footer>
</body>
</html>
