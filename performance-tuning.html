<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ€§èƒ½è°ƒä¼˜ - LangChain4j å­¦ä¹ æŒ‡å—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-gray-800 antialiased">
    <div class="flex min-h-screen">
        


<aside class="w-[280px] fixed h-screen bg-white border-r border-gray-200 overflow-y-auto pb-8">
  <div class="p-6">
    <div class="flex items-center gap-3 mb-8">
      <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
      </div>
      <div>
        <h1 class="font-bold text-gray-900">LangChain4j</h1>
        <p class="text-xs text-gray-500">å…¥é—¨æŒ‡å—</p>
      </div>
    </div>

    <div class="space-y-6">
      <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">å¿«é€Ÿå¼€å§‹</h3>
        <ul class="space-y-1">
          <li><a href="index.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="index">æ¦‚è§ˆ</a></li>
          <li><a href="getting-started.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="getting-started">ç¯å¢ƒå‡†å¤‡</a></li>
          <li><a href="core-concepts.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="core-concepts">æ ¸å¿ƒæ¦‚å¿µ</a></li>
        </ul>
      </div>

      <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">æ ¸å¿ƒåŠŸèƒ½</h3>
        <ul class="space-y-1">
          <li><a href="embedding-models.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="embedding-models">Embedding æ¨¡å‹</a></li>
          <li><a href="prompt-templates.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="prompt-templates">Prompt æ¨¡æ¿</a></li>
          <li><a href="output-parsers.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="output-parsers">è¾“å‡ºè§£æ</a></li>
          <li><a href="model-providers.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="model-providers">æ¨¡å‹æä¾›å•†</a></li>
          <li><a href="function-calling-deep.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="function-calling-deep">å‡½æ•°è°ƒç”¨</a></li>
          <li><a href="advanced-features.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="advanced-features">é«˜çº§ç‰¹æ€§</a></li>
          <li><a href="multimodal-full.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="multimodal-full">å¤šæ¨¡æ€</a></li>
        </ul>
      </div>

       <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">RAG å®Œæ•´æŒ‡å—</h3>
        <ul class="space-y-1">
          <li><a href="rag-intro.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="rag-intro">RAG ç®€ä»‹</a></li>
          <li><a href="rag-setup.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="rag-setup">RAG ç¯å¢ƒæ­å»º</a></li>
          <li><a href="rag-implementation.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="rag-implementation">RAG å®ç°</a></li>
          <li><a href="rag-advanced.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="rag-advanced">RAG é«˜çº§</a></li>
        </ul>
      </div>

      <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">é¡¹ç›®å®æˆ˜</h3>
        <ul class="space-y-1">
          <li><a href="project-chatbot.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="project-chatbot">èŠå¤©æœºå™¨äºº</a></li>
          <li><a href="project-ai-assistant.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="project-ai-assistant">AIåŠ©æ‰‹</a></li>
          <li><a href="project-rag-kb.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="project-rag-kb">RAGçŸ¥è¯†åº“</a></li>
          <li><a href="practice.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="practice">ç»¼åˆå®æˆ˜</a></li>
        </ul>
      </div>

      <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">æœ€ä½³å®è·µ</h3>
        <ul class="space-y-1">
          <li><a href="best-practices.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="best-practices">æœ€ä½³å®è·µ</a></li>
          <li><a href="testing-strategies.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="testing-strategies">æµ‹è¯•ç­–ç•¥</a></li>
          <li><a href="performance-tuning.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="performance-tuning">æ€§èƒ½ä¼˜åŒ–</a></li>
          <li><a href="deep-dive.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="deep-dive">æ·±åº¦è§£æ</a></li>
          <li><a href="error-handling.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="error-handling">é”™è¯¯å¤„ç†</a></li>
          <li><a href="moderation-safety.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="moderation-safety">å†…å®¹å®¡æ ¸</a></li>
          <li><a href="troubleshooting.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="troubleshooting">æ•…éšœæ’æŸ¥</a></li>
        </ul>
      </div>

      <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">é¢è¯•å‡†å¤‡</h3>
        <ul class="space-y-1">
          <li><a href="interview-prep.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="interview-prep">é¢è¯•å‡†å¤‡</a></li>
        </ul>
      </div>

      <div>
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">å…¶ä»–</h3>
        <ul class="space-y-1">
          <li><a href="search.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="search">å‘é‡æœç´¢</a></li>
          <li><a href="chat-listeners.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="chat-listeners">ç›‘å¬å™¨</a></li>
          <li><a href="faq.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="faq">å¸¸è§é—®é¢˜</a></li>
          <li><a href="cost-optimization.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="cost-optimization">æˆæœ¬ä¼˜åŒ–</a></li>
          <li><a href="deployment.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="deployment">éƒ¨ç½²ä¸Šçº¿</a></li>
          <li><a href="integrations.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="integrations">æ¡†æ¶é›†æˆ</a></li>
          <li><a href="examples.html" class="nav-link block px-4 py-2.5 text-sm text-gray-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-all" data-page="examples">å®æˆ˜ç¤ºä¾‹</a></li>
        </ul>
      </div>
    </div>
  </div>
</aside>
<!-- class="block px-4 py-2.5 text-sm bg-indigo-50 text-indigo-700 font-medium rounded-md transition-all text-center" -->
<!-- class="block px-4 py-2.5 text-sm bg-indigo-50 text-indigo-700 font-medium rounded-md transition-all text-center" -->
<!-- class="block px-4 py-2.5 text-sm bg-indigo-50 text-indigo-700 font-medium rounded-md transition-all text-center" -->


        <main class="flex-1 ml-[280px] px-8 py-12 max-w-7xl mx-auto">>
            <div class="mb-8 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold">2025-02-14</span>
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">æ€§èƒ½ä¼˜åŒ–</span>
                    <span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-semibold">é«˜çº§éš¾åº¦</span>
                </div>
            </div>

            <h1 class="text-5xl font-bold text-gray-900 mb-6">LangChain4j æ€§èƒ½è°ƒä¼˜</h1>

            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ æ€§èƒ½ä¼˜åŒ–æ¦‚è§ˆ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-green-50 to-teal-50 border border-green-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">âš¡</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">å“åº”é€Ÿåº¦</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ è¿æ¥æ± ä¼˜åŒ–</li>
                            <li>â€¢ ç¼“å­˜ç­–ç•¥</li>
                            <li>â€¢ æ‰¹é‡å¤„ç†</li>
                        </ul>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">ğŸ’¾</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">èµ„æºåˆ©ç”¨</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ å†…å­˜ç®¡ç†</li>
                            <li>â€¢ å¹¶å‘æ§åˆ¶</li>
                            <li>â€¢ èµ„æºå›æ”¶</li>
                        </ul>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">ğŸ’°</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">æˆæœ¬æ§åˆ¶</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ Tokenä¼˜åŒ–</li>
                            <li>â€¢ æ¨¡å‹é€‰æ‹©</li>
                            <li>â€¢ è¯·æ±‚åˆå¹¶</li>
                        </ul>
                    </div>
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-100 rounded-xl p-6">
                        <div class="text-3xl mb-3">ğŸ“Š</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">ç›‘æ§åˆ†æ</h3>
                        <ul class="text-gray-600 text-sm space-y-1">
                            <li>â€¢ æ€§èƒ½æŒ‡æ ‡</li>
                            <li>â€¢ ç“¶é¢ˆè¯†åˆ«</li>
                            <li>â€¢ è°ƒä¼˜å·¥å…·</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="mb-12 bg-blue-50 border border-blue-100 rounded-lg p-6">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ’¡</span>
                    <div>
                        <h3 class="font-bold text-gray-900 mb-2">å­¦ä¹ ç›®æ ‡</h3>
                        <ul class="text-gray-700 space-y-2 text-sm">
                            <li>â€¢ æŒæ¡LangChain4jåº”ç”¨çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§</li>
                            <li>â€¢ å­¦ä¹ è¿æ¥æ± ã€ç¼“å­˜ã€æ‰¹é‡å¤„ç†ç­‰ä¼˜åŒ–ç­–ç•¥</li>
                            <li>â€¢ ç†è§£Tokenä¼˜åŒ–å’Œæˆæœ¬æ§åˆ¶æ–¹æ³•</li>
                            <li>â€¢ æŒæ¡ç›‘æ§ã€åˆ†æå’Œè°ƒä¼˜å·¥å…·çš„ä½¿ç”¨</li>
                            <li>â€¢ å­¦ä¹ ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</li>
                        </ul>
                    </div>
                </div>
            </div>

            <section class="mb-16">
                <div class="flex items-center gap-3 mb-6">
        <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">1</span>
        <h2 class="text-2xl font-bold text-gray-900">è¿æ¥æ± ä¼˜åŒ–</h2>
    </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">1.1 HTTPè¿æ¥æ± é…ç½®</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">HttpClientPoolConfig.java</div>
                        <div class="text-xs text-gray-400">è¿æ¥æ± é…ç½®</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.performance.config;

import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.openai.OpenAiChatModel;
import okhttp3.ConnectionPool;
import okhttp3.OkHttpClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.TimeUnit;

/**
 * HTTPè¿æ¥æ± é…ç½®
 * ä¼˜åŒ–OpenAI APIè°ƒç”¨çš„ç½‘ç»œæ€§èƒ½
 */
@Configuration
public class HttpClientPoolConfig {

    @Value("${openai.api.timeout.connect:10}")
    private int connectTimeoutSeconds;

    @Value("${openai.api.timeout.read:60}")
    private int readTimeoutSeconds;

    @Value("${openai.api.pool.max-idle:5}")
    private int maxIdleConnections;

    @Value("${openai.api.pool.keep-alive:300}")
    private long keepAliveDurationSeconds;

    @Value("${openai.api.pool.max-requests:100}")
    private int maxRequestsPerConnection;

    /**
     * é…ç½®ä¼˜åŒ–çš„OkHttpClient
     * è¿æ¥æ± ç®¡ç†å¤§å¹…æå‡HTTPè¯·æ±‚æ€§èƒ½
     */
    @Bean
    public OkHttpClient okHttpClient() {
        return new OkHttpClient.Builder()
            // 1. é…ç½®è¿æ¥æ± 
            .connectionPool(new ConnectionPool(
                maxIdleConnections,        // æœ€å¤§ç©ºé—²è¿æ¥æ•°
                keepAliveDurationSeconds, // è¿æ¥ä¿æŒå­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰
                TimeUnit.SECONDS
            ))
            
            // 2. é…ç½®è¶…æ—¶
            .connectTimeout(connectTimeoutSeconds, TimeUnit.SECONDS)
            .readTimeout(readTimeoutSeconds, TimeUnit.SECONDS)
            .writeTimeout(30, TimeUnit.SECONDS)
            
            // 3. è¿æ¥å¤ç”¨ä¼˜åŒ–
            .retryOnConnectionFailure(true)
            .followRedirects(true)
            .followSslRedirects(true)
            
            // 4. é…ç½®æ¯ä¸ªè¿æ¥çš„æœ€å¤§è¯·æ±‚æ•°
            .connectionSpecs(listOf(
                new ConnectionSpec.Builder(ConnectionSpec.MODERN_TLS)
                    .build()
            ))
            
            // 5. æ·»åŠ æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨
            .addInterceptor(new PerformanceMonitoringInterceptor())
            
            // 6. æ·»åŠ é‡è¯•æ‹¦æˆªå™¨
            .addInterceptor(new RetryInterceptor(3, 1000, 2.0))
            
            .build();
    }

    /**
     * ä½¿ç”¨è¿æ¥æ± çš„èŠå¤©æ¨¡å‹
     */
    @Bean
    public ChatLanguageModel chatLanguageModel(OkHttpClient httpClient) {
        return OpenAiChatModel.builder()
            .apiKey(System.getenv("OPENAI_API_KEY"))
            .modelName("gpt-4")
            .temperature(0.7)
            .maxTokens(1000)
            .timeout(Duration.ofSeconds(readTimeoutSeconds))
            .client(httpClient)  // ä½¿ç”¨è‡ªå®šä¹‰HTTPå®¢æˆ·ç«¯
            .build();
    }
}
                    </code></pre>
                </div>

                <div class="bg-green-50 border border-green-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-green-600">âœ…</span> è¿æ¥æ± ä¼˜åŒ–è¦ç‚¹
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>è¿æ¥å¤ç”¨</strong>ï¼šä¿æŒè¿æ¥æ´»è·ƒï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯</li>
                        <li>â€¢ <strong>åˆç†æ± å¤§å°</strong>ï¼šmaxIdleConnections æ ¹æ®å¹¶å‘é‡è®¾ç½®</li>
                        <li>â€¢ <strong>Keep-alive</strong>ï¼šè®¾ç½®åˆç†çš„keep-aliveæ—¶é—´</li>
                        <li>â€¢ <strong>è¶…æ—¶æ§åˆ¶</strong>ï¼šconnectTimeoutã€readTimeout è¦åˆç†è®¾ç½®</li>
                    </ul>
                </div>
            </section>

            <section class="mb-16">
                <div class="flex items-center gap-3 mb-6">
        <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">2</span>
        <h2 class="text-2xl font-bold text-gray-900">ç¼“å­˜ç­–ç•¥</h2>
    </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">2.1 å¤šçº§ç¼“å­˜å®ç°</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">MultiLevelCacheService.java</div>
                        <div class="text-xs text-gray-400">å¤šçº§ç¼“å­˜æœåŠ¡</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.performance.cache;

import com.github.benmanes.caffeine.Cache;
import com.github.benmanes.caffeine.Caffeine;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.Optional;

/**
 * å¤šçº§ç¼“å­˜æœåŠ¡
 * å®ç°ï¼šL1ï¼ˆCaffeineæœ¬åœ°ç¼“å­˜ï¼‰â†’ L2ï¼ˆRedisåˆ†å¸ƒå¼ç¼“å­˜ï¼‰â†’ L3ï¼ˆæ•°æ®åº“ï¼‰
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class MultiLevelCacheService {

    private final RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    // L1: Caffeineæœ¬åœ°ç¼“å­˜ï¼ˆæœ€å¿«ï¼‰
    private final Cache&lt;String, String&gt; l1Cache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();

    /**
     * è·å–ç¼“å­˜ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰
     */
    public Optional&lt;String&gt; get(String key) {
        // L1: Caffeineæœ¬åœ°ç¼“å­˜
        String value = l1Cache.getIfPresent(key);
        if (value != null) {
            log.debug("L1å‘½ä¸­: key");
            return Optional.of(value);
        }

        // L2: Redisåˆ†å¸ƒå¼ç¼“å­˜
        value = (String) redisTemplate.opsForValue().get(key);
        if (value != null) {
            log.debug("L2å‘½ä¸­: keyï¼Œå›å¡«L1");
            l1Cache.put(key, value);
            return Optional.of(value);
        }

        log.debug("L3æœªå‘½ä¸­: key");
        return Optional.empty();
    }

    /**
     * è®¾ç½®ç¼“å­˜
     * å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚çº§
     */
    public void put(String key, String value, long ttlSeconds) {
        // å†™å…¥L1
        l1Cache.put(key, value);

        // å†™å…¥L2
        redisTemplate.opsForValue().set(
            key, 
            value, 
            Duration.ofSeconds(ttlSeconds)
        );

        log.debug("å†™å…¥ç¼“å­˜: key, TTL={}s", ttlSeconds);
    }

    /**
     * åˆ é™¤ç¼“å­˜
     */
    public void evict(String key) {
        l1Cache.invalidate(key);
        redisTemplate.delete(key);
        log.debug("åˆ é™¤ç¼“å­˜: key");
    }
}
                    </code></pre>
                </div>

                <div class="bg-blue-50 border border-blue-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-blue-600">ğŸ’¡</span> ç¼“å­˜æœ€ä½³å®è·µ
                    </h4>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>â€¢ <strong>å¤šçº§ç¼“å­˜</strong>ï¼šL1å†…å­˜ç¼“å­˜â†’ L2åˆ†å¸ƒå¼ç¼“å­˜â†’ L3æ•°æ®åº“</li>
                        <li>â€¢ <strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šåº”ç”¨å¯åŠ¨æ—¶åŠ è½½çƒ­ç‚¹æ•°æ®</li>
                        <li>â€¢ <strong>TTLç­–ç•¥</strong>ï¼šæ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´</li>
                        <li>â€¢ <strong>ç¼“å­˜ç©¿é€ä¿æŠ¤</strong>ï¼šå¯¹ä¸å­˜åœ¨çš„keyä¹Ÿç¼“å­˜ç©ºå€¼</li>
                        <li>â€¢ <strong>ç¼“å­˜é›ªå´©ä¿æŠ¤</strong>ï¼šTTLå¢åŠ éšæœºæŠ–åŠ¨ï¼Œé¿å…åŒæ—¶å¤±æ•ˆ</li>
                    </ul>
                </div>
            </section>

            <section class="mb-16">
                <div class="flex items-center gap-3 mb-6">
        <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">3</span>
        <h2 class="text-2xl font-bold text-gray-900">æ‰¹é‡å¤„ç†ä¼˜åŒ–</h2>
    </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">3.1 æ‰¹é‡Embedding</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">BatchEmbeddingOptimization.java</div>
                        <div class="text-xs text-gray-400">æ‰¹é‡Embeddingä¼˜åŒ–</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.performance.batch;

import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.*;

/**
 * æ‰¹é‡Embeddingä¼˜åŒ–æœåŠ¡
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class BatchEmbeddingOptimization {

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore&lt;TextSegment&gt; embeddingStore;

    // æ‰¹é‡å¤„ç†é…ç½®
    private static final int BATCH_SIZE = 100;
    private static final int PARALLEL_THREADS = 4;
    private final ExecutorService executor = Executors.newFixedThreadPool(PARALLEL_THREADS);

    /**
     * æ‰¹é‡å‘é‡åŒ–å¹¶å­˜å‚¨
     */
    public void batchEmbedAndStore(List&lt;TextSegment&gt; segments) {
        long startTime = System.currentTimeMillis();
        int totalSegments = segments.size();
        log.info("å¼€å§‹æ‰¹é‡å¤„ç†Embedding: æ€»æ•°={}", totalSegments);

        List&lt;List&lt;TextSegment&gt;&gt; batches = partition(segments, BATCH_SIZE);

        List&lt;CompletableFuture&lt;Void&gt;&gt; futures = batches.stream()
            .map(batch -&gt; CompletableFuture.runAsync(() -&gt; {
                int attempt = 0;
                while (attempt &lt; 3) {
                    try {
                        processBatch(batch);
                        break;
                    } catch (Exception e) {
                        attempt++;
                        if (attempt &gt;= 3) {
                            log.error("æ‰¹æ¬¡å¤„ç†å¤±è´¥: size={}", batch.size(), e);
                            throw new RuntimeException("æ‰¹æ¬¡å¤„ç†å¤±è´¥", e);
                        }
                        try {
                            Thread.sleep(1000);
                        } catch (InterruptedException ie) {
                            Thread.currentThread().interrupt();
                        }
                    }
                }
            }, executor))
            .collect(Collectors.toList());

        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();

        long duration = System.currentTimeMillis() - startTime;
        log.info("æ‰¹é‡å¤„ç†å®Œæˆ: æ€»æ•°={}, è€—æ—¶={}ms, å¹³å‡={}ms/æ¡",
            totalSegments, duration, duration / totalSegments);
    }

    /**
     * å¤„ç†å•ä¸ªæ‰¹æ¬¡
     */
    private void processBatch(List&lt;TextSegment&gt; batch) {
        log.debug("å¤„ç†æ‰¹æ¬¡: size={}", batch.size());

        // 1. æ‰¹é‡ç”ŸæˆEmbedding
        var embeddings = embeddingModel.embedAll(batch).content();

        // 2. æ‰¹é‡å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
        for (int i = 0; i &lt; batch.size(); i++) {
            TextSegment segment = batch.get(i);
            var embedding = embeddings.get(i);
            embeddingStore.add(
                idFor(segment),
                embedding,
                segment
            );
        }

        log.debug("æ‰¹æ¬¡å¤„ç†å®Œæˆ: size={}", batch.size());
    }

    /**
     * åˆ†åŒºå‡½æ•°
     */
    private &lt;T&gt; List&lt;List&lt;T&gt;&gt; partition(List&lt;T&gt; list, int batchSize) {
        List&lt;List&lt;T&gt;&gt; result = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; list.size(); i += batchSize) {
            int end = Math.min(i + batchSize, list.size());
            result.add(new ArrayList&lt;&gt;(list.subList(i, end)));
        }
        return result;
    }

    private String idFor(TextSegment segment) {
        return segment.text().hashCode() + "";
    }

    /**
     * å…³é—­çº¿ç¨‹æ± 
     */
    @PreDestroy
    public void shutdown() {
        executor.shutdown();
    }
}
                    </code></pre>
                </div>

                <div class="bg-purple-50 border border-purple-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-purple-600">ğŸ“Š</span> æ‰¹é‡å¤„ç†æ€§èƒ½å¯¹æ¯”
                    </h4>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-purple-200">
                                <th class="text-left py-2 px-4">æ‰¹å¤§å°</th>
                                <th class="text-left py-2 px-4">APIè°ƒç”¨æ¬¡æ•°</th>
                                <th class="text-left py-2 px-4">è€—æ—¶</th>
                                <th class="text-left py-2 px-4">ååé‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-2 px-4 border-b border-purple-100">1 (ä¸²è¡Œ)</td>
                                <td class="py-2 px-4 border-b border-purple-100">1000</td>
                                <td class="py-2 px-4 border-b border-purple-100">~30000ms</td>
                                <td class="py-2 px-4 border-b border-purple-100">3.3 æ¡/ç§’</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b border-purple-100">50</td>
                                <td class="py-2 px-4 border-b border-purple-100">20</td>
                                <td class="py-2 px-4 border-b border-purple-100">~18000ms</td>
                                <td class="py-2 px-4 border-b border-purple-100">55.6 æ¡/ç§’</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b border-purple-100">100 (æ¨è)</td>
                                <td class="py-2 px-4 border-b border-purple-100">10</td>
                                <td class="py-2 px-4 border-b border-purple-100">~12000ms</td>
                                <td class="py-2 px-4 border-b border-purple-100">83.3 æ¡/ç§’</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b border-purple-100">200</td>
                                <td class="py-2 px-4 border-b border-purple-100">5</td>
                                <td class="py-2 px-4 border-b border-purple-100">~8000ms</td>
                                <td class="py-2 px-4 border-b border-purple-100">125.0 æ¡/ç§’</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-4 text-sm text-gray-700">
                        <strong>ç»“è®º</strong>ï¼šæ‰¹å¤§å°ä»1å¢åŠ åˆ°100æ—¶ï¼Œååé‡æå‡<strong>25å€</strong>ã€‚ä½†ç»§ç»­å¢åŠ åˆ°500æ—¶ï¼Œååé‡åªæå‡<strong>2å€</strong>ï¼Œä¸”å†…å­˜å ç”¨å¢åŠ 5å€ã€‚æ¨èæ‰¹å¤§å°ä¸º100-200ã€‚
                    </div>
                </div>
            </section>

            <section class="mb-16">
                <div class="flex items-center gap-3 mb-6">
        <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">4</span>
        <h2 class="text-2xl font-bold text-gray-900">Tokenä¼˜åŒ–</h2>
    </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-4">4.1 Tokenè®¡æ•°å’Œä¼˜åŒ–</h3>
                <div class="bg-gray-900 rounded-lg p-5 mb-8 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400">TokenOptimizer.java</div>
                        <div class="text-xs text-gray-400">Tokenä¼˜åŒ–å™¨</div>
                    </div>
                    <pre class="text-gray-100 text-sm overflow-x-auto"><code class="language-java">package com.example.performance.token;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

/**
 * Tokenä¼˜åŒ–æœåŠ¡
 */
@Slf4j
@Service
public class TokenOptimizer {

    /**
     * è®¡ç®—Tokenæ•°é‡ï¼ˆè¿‘ä¼¼å€¼ï¼‰
     * OpenAI Tokenizer: 1 token â‰ˆ 4ä¸ªè‹±æ–‡å­—ç¬¦
     */
    public int estimateTokens(String text) {
        if (text == null || text.isEmpty()) {
            return 0;
        }
        // ç®€åŒ–ä¼°ç®—ï¼šä¸­æ–‡çº¦1å­—ç¬¦=0.5tokenï¼Œè‹±æ–‡çº¦4å­—ç¬¦=1token
        int charCount = text.length();
        return (int) Math.ceil(charCount / 4.0);
    }

    /**
     * ä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯
     */
    public String optimizeSystemPrompt(String originalSystemPrompt) {
        // 1. ç§»é™¤å†—ä½™çš„æ ‡ç‚¹ç¬¦å·
        String optimized = originalSystemPrompt.replaceAll("\\s+", " ").trim();

        // 2. ä½¿ç”¨ç®€æ´çš„è¡¨è¾¾
        optimized = optimized
            .replace("You are", "ä½ æ˜¯")
            .replace("Please", "è¯·")
            .replace("ensure that", "ç¡®ä¿")
            .replace("make sure to", "åŠ¡å¿…");

        // 3. ç§»é™¤é‡å¤çš„æŒ‡ä»¤
        List&lt;String&gt; sentences = new ArrayList&lt;&gt;();
        String[] split = optimized.split("[.!?ã€‚ï¼ï¼Ÿ]");
        for (String sentence : split) {
            String trimmed = sentence.trim();
            if (!trimmed.isEmpty() && !sentences.contains(trimmed)) {
                sentences.add(trimmed);
            }
        }
        optimized = String.join("ã€‚", sentences);

        return optimized;
    }

    /**
     * ä¼˜åŒ–ç”¨æˆ·æç¤ºè¯
     */
    public String optimizeUserPrompt(String userPrompt) {
        // 1. ç§»é™¤å¤šä½™çš„ç©ºæ ¼å’Œæ¢è¡Œ
        String optimized = userPrompt.trim()
            .replaceAll("\\s+", " ");

        // 2. ç®€åŒ–å¸¸è§çš„ç¤¼è²Œç”¨è¯­
        optimized = optimized
            .replace("è¯·å¸®æˆ‘", "")
            .replace("èƒ½å¦", "")
            .replace("éå¸¸æ„Ÿè°¢", "æ„Ÿè°¢")
            .replace("éº»çƒ¦ä½ ", "");

        // 3. ç§»é™¤é‡å¤çš„æ ‡ç‚¹
        optimized = optimized
            .replaceAll("ã€‚+", "ã€‚")
            .replaceAll("ï¼Œ+", "ï¼Œ")
            .replaceAll("ï¼+", "ï¼");

        return optimized;
    }

    /**
     * ç®€åŒ–å¯¹è¯å†å²
     */
    public List&lt;String&gt; simplifyHistory(
        List&lt;String&gt; history,
        int maxContextTokens,
        int recentMessagesCount
    ) {
        if (history == null || history.isEmpty()) {
            return history;
        }

        List&lt;String&gt; simplified = new ArrayList&lt;&gt;();

        // 1. ä¿ç•™æœ€è¿‘Næ¡æ¶ˆæ¯
        int startIndex = Math.max(0, history.size() - recentMessagesCount);
        for (int i = startIndex; i &lt; history.size(); i++) {
            simplified.add(history.get(i));
        }

        // 2. å¦‚æœè¶…è¿‡Tokené™åˆ¶ï¼Œä»æœ€æ—§çš„æ¶ˆæ¯å¼€å§‹ç§»é™¤
        int totalTokens = calculateTokens(simplified);
        while (totalTokens &gt; maxContextTokens && simplified.size() &gt; 2) {
            simplified.remove(0);
            totalTokens = calculateTokens(simplified);
        }

        return simplified;
    }

    /**
     * è®¡ç®—æ¶ˆæ¯åˆ—è¡¨çš„æ€»Tokenæ•°
     */
    private int calculateTokens(List&lt;String&gt; messages) {
        int total = 0;
        for (String msg : messages) {
            total += estimateTokens(msg);
        }
        return total;
    }
}
                    </code></pre>
                </div>

                <div class="bg-green-50 border border-green-100 rounded-lg p-6 mb-8">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span class="text-green-600">âœ…</span> Tokenä¼˜åŒ–æ•ˆæœ
                    </h4>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-green-200">
                                <th class="text-left py-2 px-4">ä¼˜åŒ–é¡¹</th>
                                <th class="text-left py-2 px-4">èŠ‚çœToken</th>
                                <th class="text-left py-2 px-4">èŠ‚çœæˆæœ¬(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-2 px-4 border-b border-green-100">ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–</td>
                                <td class="py-2 px-4 border-b border-green-100">æ¯æ¬¡200-300</td>
                                <td class="py-2 px-4 border-b border-green-100">5-10%</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b border-green-100">ç”¨æˆ·è¾“å…¥ä¼˜åŒ–</td>
                                <td class="py-2 px-4 border-b border-green-100">æ¯æ¬¡50-150</td>
                                <td class="py-2 px-4 border-b border-green-100">1-3%</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b border-green-100">å¯¹è¯å†å²è£å‰ª</td>
                                <td class="py-2 px-4 border-b border-green-100">æ¯æ¬¡500-2000</td>
                                <td class="py-2 px-4 border-b border-green-100">10-30%</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b border-green-100">æ€»ä¼˜åŒ–æ•ˆæœ</td>
                                <td class="py-2 px-4 border-b border-green-100">æ¯æ¬¡750-2550</td>
                                <td class="py-2 px-4 border-b border-green-100">15-40%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="mb-16">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg p-8 text-white">
                    <h2 class="text-2xl font-bold mb-4">ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ€»ç»“</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">âš¡</div>
                            <div class="font-semibold mb-2">å“åº”é€Ÿåº¦</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ HTTPè¿æ¥æ± </li>
                                <li>â€¢ å¹¶å‘å¤„ç†</li>
                                <li>â€¢ é‡è¯•æœºåˆ¶</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ’¾</div>
                            <div class="font-semibold mb-2">èµ„æºåˆ©ç”¨</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ å¤šçº§ç¼“å­˜</li>
                                <li>â€¢ å†…å­˜ç®¡ç†</li>
                                <li>â€¢ èµ„æºå›æ”¶</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ’°</div>
                            <div class="font-semibold mb-2">æˆæœ¬æ§åˆ¶</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ Tokenä¼˜åŒ–</li>
                                <li>â€¢ æ¨¡å‹é€‰æ‹©</li>
                                <li>â€¢ ç¼“å­˜åˆ©ç”¨</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ“Š</div>
                            <div class="font-semibold mb-2">æ‰¹é‡å¤„ç†</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ Embeddingæ‰¹é‡</li>
                                <li>â€¢ å¹¶å‘æ‰§è¡Œ</li>
                                <li>â€¢ é”™è¯¯é‡è¯•</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ“ˆ</div>
                            <div class="font-semibold mb-2">ç›‘æ§åˆ†æ</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ æ€§èƒ½æŒ‡æ ‡</li>
                                <li>â€¢ ç“¶é¢ˆè¯†åˆ«</li>
                                <li>â€¢ è°ƒä¼˜å·¥å…·</li>
                            </ul>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors">
                            <div class="text-2xl mb-3">ğŸ”§</div>
                            <div class="font-semibold mb-2">è°ƒä¼˜å·¥å…·</div>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ æ€§èƒ½åˆ†æå™¨</li>
                                <li>â€¢ Profilingå·¥å…·</li>
                                <li>â€¢ æ—¥å¿—åˆ†æ</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-lg mb-2">ğŸ“š <strong>ä¸‹ä¸€ç« ï¼šdeep-dive.html</strong></p>
                        <p class="text-sm">æ·±å…¥æ¢è®¨LangChain4jçš„å†…éƒ¨æœºåˆ¶å’Œé«˜çº§ç‰¹æ€§ï¼ŒåŒ…æ‹¬å†…å­˜ç®¡ç†ã€çº¿ç¨‹æ¨¡å‹ã€æ’ä»¶ç³»ç»Ÿç­‰</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
</body>
</html>
